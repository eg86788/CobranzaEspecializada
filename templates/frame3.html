{% extends "base.html" %}

{% block title %}Cuentas — Captura{% endblock %}

{% block content %}

<!-- ===== RESUMEN DE SOLICITUD (mismo estilo que frame2) ===== -->
<div class="card shadow-sm mb-4 border-0">
  <div class="card-header d-flex align-items-center justify-content-between" style="background:#003746; color:#fff;">
    <div class="d-flex align-items-center gap-2">
      <strong>Resumen de la solicitud</strong>
    </div>
    <a href="{{ url_for('frames.frame1') }}" class="btn btn-outline-light btn-sm">✎ Editar</a>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0 align-middle">
        <tbody>
          <tr>
            <th class="text-muted fw-semibold" style="width:18%">Cliente</th>
            <td style="width:32%">{{ frame1.numero_cliente }} - {{ frame1.razon_social }}</td>
            <th class="text-muted fw-semibold" style="width:18%">Segmento</th>
            <td style="width:32%">{{ frame1.segmento or '-' }}</td>
          </tr>
          <tr>
            <th class="text-muted fw-semibold">Contrato</th>
            <td>{{ frame1.numero_contrato or '-' }}</td>
            <th class="text-muted fw-semibold">Tipo Trámite</th>
            <td>{{ frame1.tipo_tramite or '-' }}</td>
          </tr>
          <tr>
            <th class="text-muted fw-semibold">Tipo Contrato</th>
            <td>{{ frame1.tipo_contrato or '-' }}</td>
            <th class="text-muted fw-semibold">Servicio</th>
            <td id="servicio_general">{{ frame1.tipo_servicio or '-' }}</td>
          </tr>
          <tr>
            <th class="text-muted fw-semibold">Tipo Cobro Comisión</th>
            <td>{{ frame1.tipo_cobro or '-' }}</td>
            <th class="text-muted fw-semibold">Importe Máximo de Diferencias</th>
            <td>{{ frame1.importe_maximo_dif or '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== UNIDADES DE NEGOCIO (resumen compacto) ===== -->
<div class="card shadow-sm mb-4 border-0">
  <div class="card-header d-flex align-items-center justify-content-between" style="background:#003746; color:#fff;">
    <div class="d-flex align-items-center gap-2">
      <strong>Unidades de Negocio</strong>
    </div>
    <a href="{{ url_for('frames.frame2') }}" class="btn btn-outline-light btn-sm">✎ Editar</a>
  </div>
  <div class="card-body p-0">
    {% if unidades %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:48px">#</th>
              <th>Nombre</th>
              <th>CPAE</th>
              <th>Servicio</th>
              <th>ETV</th>
              <th>Terminal SEF</th>
            </tr>
          </thead>
          <tbody>
            {% for u in unidades %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ u.nombre_unidad }}</td>
              <td>{{ u.cpae_nombre }}</td>
              <td>{{ u.tipo_servicio_unidad }}</td>
              <td>{{ u.etv_nombre }}</td>
              <td>{{ u.numero_terminal_sef or '-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-3 text-muted">Aún no hay unidades capturadas.</div>
    {% endif %}
  </div>
</div>

<!-- ===== ALERTAS ===== -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- ===== FORMULARIO: CUENTAS (look & feel frame2 + tooltips) ===== -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-header d-flex align-items-center gap-2" style="background:#F7FBFD; color:#003746;">
    <h2 class="h5 mb-0 d-flex align-items-center gap-2">
      <i class="bi bi-bank"></i><span>Captura de Cuentas</span>
    </h2>
  </div>

  <div class="card-body">
    <form method="POST" class="needs-validation" novalidate autocomplete="off">
      <!-- Oculto para modal USD -->
      <input type="hidden" id="hidden_confirmacion_usd" name="confirmacion_usd" value="">

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">
            Terminal SEF a donde aplica *
            <i class="bi bi-info-circle-fill text-primary ms-1" data-bs-toggle="tooltip"
               title="Selecciona la unidad a la que aplica esta cuenta o elige TODAS."></i>
          </label>
          <select class="form-select" name="terminal_aplica" id="terminal_aplica" required>
            <option value="">Selecciona...</option>
            <option value="TODAS">TODAS LAS UNIDADES</option>
            {% for u in unidades %}
              <option value="{{ u.nombre_unidad }}">{{ u.nombre_unidad }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">
            Servicio a aplicar *
            <i class="bi bi-info-circle-fill text-primary ms-1" data-bs-toggle="tooltip"
               title="Las opciones se limitan según el servicio de la unidad seleccionada."></i>
          </label>
          <select class="form-select" name="servicio" id="servicio" required>
            <option value="">Selecciona...</option>
            <option>DOTACIÓN</option>
            <option>DEPÓSITO</option>
            <option>COMISIÓN</option>
          </select>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-4">
          <label class="form-label">
            Sucursal (4 dígitos) *
            <i class="bi bi-info-circle-fill text-primary ms-1" data-bs-toggle="tooltip"
               title="Solo números. Si son menos de 4, se completan con ceros a la izquierda."></i>
          </label>
          <input type="text" class="form-control" name="sucursal" id="sucursal" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">
            Cuenta (7 dígitos) *
            <i class="bi bi-info-circle-fill text-primary ms-1" data-bs-toggle="tooltip"
               title="Solo números. Si son menos de 7, se completan con ceros a la izquierda."></i>
          </label>
          <input type="text" class="form-control" name="cuenta" id="cuenta" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">
            Moneda *
            <i class="bi bi-info-circle-fill text-primary ms-1" data-bs-toggle="tooltip"
               title="Si eliges USD, deberás confirmar que el cliente tiene servicio en dólares."></i>
          </label>
          <select class="form-select" name="moneda" id="moneda" required>
            <option value="">Selecciona...</option>
            <option>MXN - (PESOS)</option>
            <option>USD - DÓLARES</option>
          </select>
        </div>
      </div>

      <div class="d-flex justify-content-end mt-4 gap-2">
        <button type="reset" class="btn btn-outline-secondary" id="btnLimpiar">Limpiar</button>
        <button type="submit" class="btn btn-success">
          <i class="bi bi-plus-circle"></i> Agregar Cuenta
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ===== CUENTAS CAPTURADAS ===== -->
<div class="card shadow-sm border-0">
  <div class="card-header bg-white d-flex align-items-center justify-content-between">
    <h3 class="h6 mb-0">Cuentas Capturadas</h3>

    {% if cuentas %}
      {% if frame1.tipo_contrato == 'SEF ELECTRÓNICO' %}
        <!-- Solo SEF ELECTRÓNICO puede avanzar a Usuarios (Frame 4) -->
        <form method="GET" action="{{ url_for('frames.frame4') }}" class="mb-0">
          <button type="submit" class="btn btn-primary btn-sm">Siguiente – Usuarios SEF</button>
        </form>
      {% else %}
        <!-- Para CPAE TRADICIONAL (u otros), saltar a Contactos (Frame 5) -->
        <form method="GET" action="{{ url_for('frames.frame5') }}" class="mb-0">
          <button type="submit" class="btn btn-primary btn-sm">Siguiente – Contactos</button>
        </form>
      {% endif %}
    {% endif %}
  </div>

  <div class="card-body">
    {% if cuentas %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th style="width:48px">#</th>
              <th>Servicio</th>
              <th>Cuenta</th>
              <th>Sucursal</th>
              <th>Moneda</th>
              <th>Terminal Aplicable</th>
              <th class="text-center" style="width:96px">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for c in cuentas %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ c.servicio }}</td>
              <td>{{ c.cuenta }}</td>
              <td>{{ c.sucursal }}</td>
              <td>{{ c.moneda }}</td>
              <td>{{ c.terminal_aplica }}</td>
              <td class="text-center">
                <form method="POST" class="m-0">
                  <input type="hidden" name="eliminar" value="{{ loop.index0 }}">
                  <button type="submit" class="btn btn-sm btn-outline-danger" title="Eliminar cuenta">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted mb-0">Aún no se ha agregado ninguna cuenta.</p>
    {% endif %}
  </div>
</div>


<!-- ===== MODAL: Confirmación USD ===== -->
<div class="modal fade" id="modalConfirmacionUSD" tabindex="-1" aria-labelledby="modalConfirmacionUSDLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalConfirmacionUSDLabel">Confirmar servicio en dólares</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        Estás ingresando una cuenta en dólares. ¿El cliente tiene contratado el servicio en dólares (hasta $14,000 USD mensuales)?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="btnUsdSi" data-bs-dismiss="modal">Sí</button>
        <button type="button" class="btn btn-danger" id="btnUsdNo" data-bs-dismiss="modal">No</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== SCRIPTS ===== -->

<!-- Tooltips (activar en todos los campos con data-bs-toggle="tooltip") -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const els = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  els.map(el => new bootstrap.Tooltip(el));
});
</script>

<!-- Filtrado de “Servicio a aplicar” según unidad seleccionada (coherente con frame2) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const terminalSelect = document.getElementById('terminal_aplica');
  const servicioSelect = document.getElementById('servicio');

  // Mapa de reglas por tipo de servicio de la UNIDAD (igual que frame2)
  const reglas = {
    "DEPÓSITO TRADICIONAL": ["DEPÓSITO", "COMISIÓN"],
    "DEPÓSITO ELECTRÓNICO": ["DEPÓSITO", "COMISIÓN"],
    "DOTACIÓN ELECTRÓNICA": ["DOTACIÓN", "COMISIÓN"],
    "DEPÓSITO ELECTRÓNICO Y DOTACIÓN ELECTRÓNICA": ["DEPÓSITO", "DOTACIÓN", "COMISIÓN"],
    "CENTRALIZADA (SOLO DOTACIÓN)": ["DOTACIÓN", "COMISIÓN"],
    "INTEGRADORA (SOLO DEPÓSITO)": ["DEPÓSITO", "COMISIÓN"],
    "DEPOSITO CLIENTE CERTIFICADO": ["DEPÓSITO", "COMISIÓN"],
    "CENTRALIZADA CLIENTE CERTIFICADO": ["DEPÓSITO", "COMISIÓN"]
  };

  // nombre_unidad -> tipo_servicio_unidad
  const tiposPorUnidad = {
    {% for u in unidades %}
      "{{ u.nombre_unidad }}": "{{ u.tipo_servicio_unidad }}",
    {% endfor %}
  };

  function actualizarOpcionesServicio() {
    servicioSelect.innerHTML = '<option value=\"\">Selecciona...</option><option>DOTACIÓN</option><option>DEPÓSITO</option><option>COMISIÓN</option>';

    const set = new Set();
    if (terminalSelect.value === 'TODAS') {
      Object.values(tiposPorUnidad).forEach(tipo => (reglas[tipo]||[]).forEach(op => set.add(op)));
    } else {
      (reglas[tiposPorUnidad[terminalSelect.value]] || []).forEach(op => set.add(op));
    }

    // filtra visualmente
    Array.from(servicioSelect.options).forEach(opt => {
      if (!opt.value) return;
      const ok = set.size === 0 || set.has(opt.value);
      opt.disabled = !ok;
      opt.style.display = ok ? 'block' : 'none';
    });

    // si lo que estaba seleccionado ya no es válido, resetea
    if (servicioSelect.value && !set.has(servicioSelect.value)) {
      servicioSelect.value = '';
    }
  }

  terminalSelect && terminalSelect.addEventListener('change', actualizarOpcionesServicio);
  actualizarOpcionesServicio();
});
</script>

<!-- Modal de confirmación para cuentas en USD -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const moneda = document.getElementById('moneda');
  const hidden = document.getElementById('hidden_confirmacion_usd');

  moneda && moneda.addEventListener('change', function () {
    if (this.value.includes('USD')) {
      const modal = new bootstrap.Modal(document.getElementById('modalConfirmacionUSD'));
      modal.show();
      document.getElementById('btnUsdSi').onclick = () => hidden.value = 'SI';
      document.getElementById('btnUsdNo').onclick = () => hidden.value = 'NO';
    } else {
      hidden.value = '';
    }
  });
});
</script>

<!-- Reglas pedidas: máscaras y padding para Sucursal (4) y Cuenta (7) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  function maskPad(el, len) {
    if (!el) return;
    el.setAttribute('maxlength', String(len));
    el.setAttribute('inputmode', 'numeric');
    el.setAttribute('pattern', '\\d*');

    el.addEventListener('input', function () {
      this.value = this.value.replace(/\D/g, '').slice(0, len);
    }, { passive: true });

    el.addEventListener('blur', function () {
      const v = (this.value || '').replace(/\D/g, '');
      this.value = v.padStart(len, '0');
    });

    // normaliza si ya viene valor precargado
    const v0 = (el.value || '').replace(/\D/g, '');
    if (v0 && v0.length < len) el.value = v0.padStart(len, '0');
  }

  maskPad(document.getElementById('sucursal'), 4);
  maskPad(document.getElementById('cuenta'),   7);
});
</script>

{% endblock %}
