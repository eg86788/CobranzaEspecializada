{% extends "base.html" %}

{% block title %}Resumen y Finalizaci√≥n{% endblock %}

{% block content %}

{% if imprimir_pdf %}
<style>
  @font-face {
    font-family: 'Inter';
    src: url("{{ url_for('static', filename='fonts/Inter-Regular.ttf') }}") format('truetype');
  }

  @page {
    size: A4 landscape;
    margin: 1cm;

    @bottom-right {
      content: "P√°gina " counter(page) " de " counter(pages);
      font-family: 'Arial Narrow', Arial, sans-serif;
      font-size: 9px;
      color: #666;
    }
  }

  body, h2, h3, p, th, td {
    font-family: 'Arial Narrow', Arial, sans-serif;
    color: #0a0a0a;
    font-size: 12px;
    line-height: 1.5;
  }

  h1 {
    font-family: 'Arial Narrow', Arial, sans-serif;
    color: #ffffff;
    font-size: 12px;
    line-height: 1.5;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 12px;
    font-size: inherit;
  }

  thead tr {
    background-color: #DAE9EE;
  }

  th, td {
    border: 1px solid #cccccc;
    padding: 6px 10px;
    text-align: left;
    vertical-align: top;
  }

  .card-header {
    background-color: #F0F0F0;
    font-weight: bold;
    padding: 8px 12px;
    border-bottom: 1px solid #ccc;
  }

  .bg-light {
    background-color: #f9f9f9 !important;
  }  
</style>
{% endif %}

{% if imprimir_pdf %}
<!-- Encabezado PDF -->
<div style="display: flex; align-items: center;">
  <div style="background-color: white; padding: 5px;">
    <img src="file:/Users/edgargarcia/Documents/CobranzaSEF/static/banamex_neg.png" alt="Logo Banamex" style="height: 60px;">
  </div>
  <div style="background-color: #003746; color: white; padding: 10px 20px; flex: 1;">
    <h1 style="margin: 0; font-size: 18px; white-space: nowrap;">Servicios de Efectivo | Anexo Operativo</h1>
    <p style="margin: 0; font-size: 12px; color: white;">Cascar√≥n 204</p>
  </div>
</div>
{% else %}
<h2 class="mt-4">Resumen de la Solicitud</h2>
{% endif %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- ===== RESUMEN DE LA SOLICITUD ===== -->
<div class="card shadow-sm mb-4 border-0">
  <div class="card-header d-flex align-items-center justify-content-between" style="background:#003746; color:#fff;">
    <div class="d-flex align-items-center gap-2">
      <strong>Resumen de la solicitud</strong>
    </div>
    {% if not imprimir_pdf %}
    <a href="{{ url_for('frames.frame1') }}" class="btn btn-outline-light btn-sm">‚úé Editar</a>
    {% endif %}
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0 align-middle">
        <tbody>
          <tr>
            <th class="text-muted fw-semibold" style="width:18%">Cliente</th>
            <td style="width:32%">{{ frame1.numero_cliente }} - {{ frame1.razon_social }}</td>
            <th class="text-muted fw-semibold" style="width:18%">Segmento</th>
            <td style="width:32%">{{ frame1.segmento or '-' }}</td>
          </tr>
          <tr>
            <th class="text-muted fw-semibold">Contrato</th>
            <td>{{ frame1.numero_contrato or '-' }}</td>
            <th class="text-muted fw-semibold">Tipo Tr√°mite</th>
            <td id="tipo_tramite_val">{{ frame1.tipo_tramite or '-' }}</td>
          </tr>
          <tr>
            <th class="text-muted fw-semibold">Tipo Contrato</th>
            <td id="tipo_contrato_val">{{ frame1.tipo_contrato or '-' }}</td>
            <th class="text-muted fw-semibold">Servicio</th>
            <td id="servicio_general">{{ frame1.tipo_servicio or '-' }}</td>
          </tr>
          <tr>
            <th class="text-muted fw-semibold">Tipo Cobro Comisi√≥n</th>
            <td id="tipo_cobro_val">{{ frame1.tipo_cobro or '-' }}</td>
            <th class="text-muted fw-semibold">Importe M√°ximo de Diferencias</th>
            <td>{{ frame1.importe_maximo_dif or '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== UNIDADES ===== -->
<div class="card shadow-sm mb-4 border-0">
  <div class="card-header d-flex align-items-center justify-content-between" style="background:#003746; color:#fff;">
    <div class="d-flex align-items-center gap-2">
      <strong>Unidades de Negocio</strong>
    </div>
    {% if not imprimir_pdf %}
    <a href="{{ url_for('frames.frame2') }}" class="btn btn-outline-light btn-sm">‚úé Editar</a>
    {% endif %}
  </div>
  <div class="card-body p-0">
    {% if unidades %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:48px">#</th>
              <th>Nombre</th>
              <th>CPAE</th>
              <th>Servicio</th>
              <th>ETV</th>
              <th>Terminal SEF</th>
            </tr>
          </thead>
          <tbody>
            {% for u in unidades %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ u.nombre_unidad }}</td>
              <td>{{ u.cpae_nombre }}</td>
              <td>{{ u.tipo_servicio_unidad }}</td>
              <td>{{ u.etv_nombre }}</td>
              <td>{{ u.numero_terminal_sef or '-' }}</td>
            </tr>
            <tr class="table-light small">
              <td colspan="6">
                <strong>Direcci√≥n:</strong> {{ u.calle_numero }}, {{ u.colonia }}, {{ u.municipio_nombre }}, {{ u.estado_nombre }}, CP {{ u.codigo_postal }}.
                &nbsp;|&nbsp; <strong>Integradora:</strong> {{ u.terminal_integradora or '-' }}
                &nbsp;|&nbsp; <strong>Dotaci√≥n Centralizada:</strong> {{ u.terminal_dotacion_centralizada or '-' }}
                &nbsp;|&nbsp; <strong>Certificado Centralizada:</strong> {{ u.terminal_certificado_centralizada or '-' }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-3 text-muted">A√∫n no hay unidades capturadas.</div>
    {% endif %}
  </div>
</div>

<!-- ===== CUENTAS ===== -->
<div class="card shadow-sm mb-4 border-0">
  <div class="card-header d-flex align-items-center justify-content-between" style="background:#003746; color:#fff;">
    <div class="d-flex align-items-center gap-2">
      <strong>Cuentas Bancarias</strong>
    </div>
    {% if not imprimir_pdf %}
    <a href="{{ url_for('frames.frame3') }}" class="btn btn-outline-light btn-sm">‚úé Editar</a>
    {% endif %}
  </div>
  <div class="card-body p-0">
    {% if cuentas %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:48px">#</th>
              <th>Servicio</th>
              <th>No. Sucursal</th>
              <th>No. Cuenta</th>
              <th>Moneda</th>
              <th>Terminal SEF Aplica</th>
            </tr>
          </thead>
          <tbody>
            {% for c in cuentas %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ c.servicio }}</td>
              <td>{{ c.sucursal }}</td>
              <td>{{ c.cuenta }}</td>
              <td>{{ c.moneda }}</td>
              <td>{{ c.terminal_aplica or '-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-3 text-muted">A√∫n no hay cuentas capturadas.</div>
    {% endif %}
  </div>
</div>

<!-- ===== USUARIOS (si SEF ELECTR√ìNICO) ===== -->
{% if frame1.tipo_contrato == 'SEF ELECTR√ìNICO' %}
<div class="card shadow-sm mb-4 border-0">
  <div class="card-header d-flex align-items-center justify-content-between" style="background:#003746; color:#fff;">
    <div class="d-flex align-items-center gap-2">
      <strong>Usuarios SEF</strong>
    </div>
    {% if not imprimir_pdf %}
    <a href="{{ url_for('frames.frame4') }}" class="btn btn-outline-light btn-sm">‚úé Editar</a>
    {% endif %}
  </div>
  <div class="card-body p-0">
    {% if usuarios %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:48px">#</th>
              <th>Nombre</th>
              <th>Clave Usuario</th>
              <th>Perfil</th>
              <th>Maker/Checker</th>
              <th>Correo</th>
              <th>Tel√©fono</th>
              <th>Terminal SEF Aplica</th>
            </tr>
          </thead>
          <tbody>
            {% for usuario in usuarios %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ usuario.nombre_usuario }}</td>
              <td>{{ usuario.clave_usuario }}</td>
              <td>{{ usuario.perfil }}</td>
              <td>{{ usuario.maker_checker }}</td>
              <td>{{ usuario.correo }}</td>
              <td>{{ usuario.telefono }}</td>
              <td>{{ usuario.terminal_aplica }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-3 text-muted">A√∫n no hay usuarios capturados.</div>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- ===== CONTACTOS ===== -->
<div class="card shadow-sm mb-4 border-0">
  <div class="card-header d-flex align-items-center justify-content-between" style="background:#003746; color:#fff;">
    <div class="d-flex align-items-center gap-2">
      <strong>Contactos</strong>
    </div>
    {% if not imprimir_pdf %}
    <a href="{{ url_for('frames.frame5') }}" class="btn btn-outline-light btn-sm">‚úé Editar</a>
    {% endif %}
  </div>
  <div class="card-body p-0">
    {% if cuentas %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:48px">#</th>
              <th>Nombre</th>
              <th>Correo electr√≥nico</th>
              <th>Telefono</th>
              <th>Tipo Contacto</th>
              <th>Terminal SEF Aplica</th>
            </tr>
          </thead>
          <tbody>
            {% for c in contactos %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ c.nombre_contacto or c.contacto_nombre }}</td>
              <td>{{ c.correo or c.contacto_correo }}</td>
              <td>{{ c.telefono or c.contacto_telefono or '-' }}</td>
              <td>{{ c.tipos_contacto or '-' }}</td>
              <td>{{ c.numero_terminal_sef or c.contacto_terminales_aplica or 'TODAS' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-3 text-muted">A√∫n no hay cuentas capturadas.</div>
    {% endif %}
  </div>
</div>

{% if imprimir_pdf %}
<!-- Secci√≥n de firmas para PDF -->
<div class="card mb-3">
  <div class="card-header text-white fw-semibold py-2 px-3 rounded-top-4" style="background-color: #003746; color:#ffffff">Firmas</div>
  <div class="card-body p-0">
    <table>
      <thead>
        <tr>
          <th>Apoderado Legal (Cliente)</th>
          <th>Autorizador (Banco)</th>
          <th>Director Divisional (Banco)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <strong>Raz√≥n Social:</strong><br>{{ frame1.razon_social }}<br>
            <strong>Nombre:</strong><br>{{ apoderado_legal }}
          </td>
          <td>
            <strong>Banco:</strong><br>BANCO NACIONAL DE M√âXICO S.A. DE C.V.<br>
            <strong>Nombre:</strong><br>{{ nombre_autorizador }}<br>
            <strong>Puesto:</strong><br>{{ puesto_autorizador }}
          </td>
          <td>
            <strong>Banco:</strong><br>BANCO NACIONAL DE M√âXICO S.A. DE C.V.<br>
            <strong>Nombre:</strong><br>{{ nombre_director_divisional }}<br>
            <strong>Puesto:</strong><br>{{ puesto_director_divisional }}
          </td>
        </tr>
        <tr>
          <td style="padding-top: 30px;"><strong>Firma:</strong><br><hr></td>
          <td style="padding-top: 30px;"><strong>Firma:</strong><br><hr></td>
          <td style="padding-top: 30px;"><strong>Firma:</strong><br><hr></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
{% else %}
<!-- Formulario visual de Firmantes (sin botones para no mover dise√±o) -->
<form method="POST" class="card card-body mb-3" id="formFirmantes">
  <div class="row mb-3">
    <div class="col-md-6">
      <label for="apoderado_legal" class="form-label">
        Apoderado Legal (Cliente) <span class="text-danger">*</span>
        <i class="bi bi-info-circle-fill text-primary ms-1" data-bs-toggle="tooltip"
           title="Nombre completo del representante legal del cliente que firmar√°."></i>
      </label>
      <input type="text" name="apoderado_legal" id="apoderado_legal" class="form-control"
             required pattern="[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√± 0-9]+"
             value="{{ session.get('apoderado_legal') or frame1.apoderado_legal or '' }}">
    </div>
    <div class="col-md-6">
      <label for="fecha_firma" class="form-label">
        Fecha de Firma Contrato <span class="text-danger">*</span>
        <i class="bi bi-info-circle-fill text-primary ms-1" data-bs-toggle="tooltip"
           title="Fecha en formato DD/MM/AAAA en que se firmar√° el contrato."></i>
      </label>      
      <input type="text" name="fecha_firma" id="fecha_firma" class="form-control" required
             placeholder="dd/mm/aaaa" maxlength="10"
             value="{{ session.get('fecha_firma') or '' }}">
      <div id="error_fecha" class="text-danger small mt-1" style="display: none;">Formato de fecha inv√°lido</div>
    </div>
  </div>
  <div class="row mb-3">
    <div class="col-md-6">
      <label for="nombre_autorizador" class="form-label">
        Nombre del Autorizador 1 (Banamex) <span class="text-danger">*</span>
        <i class="bi bi-info-circle-fill text-primary ms-1" data-bs-toggle="tooltip"
           title="Nombre del primer autorizador del banco que firmar√°."></i>
      </label>      
      <input type="text" name="nombre_autorizador" id="nombre_autorizador" class="form-control" required
             value="{{ session.get('nombre_autorizador') or '' }}">
    </div>
    <div class="col-md-6">
      <label for="puesto_autorizador" class="form-label">
        Puesto <span class="text-danger">*</span>
        <i class="bi bi-info-circle-fill text-primary ms-1" data-bs-toggle="tooltip"
           title="Cargo o puesto del primer autorizador."></i>
      </label>
            <input type="text" name="puesto_autorizador" id="puesto_autorizador" class="form-control" required
             value="{{ session.get('puesto_autorizador') or '' }}">
    </div>
  </div>
  <div class="row mb-3">
    <div class="col-md-6">
      <label for="nombre_director_divisional" class="form-label">
        Nombre del Autorizador 2 (Banamex) <span class="text-danger">*</span>
        <i class="bi bi-info-circle-fill text-primary ms-1" data-bs-toggle="tooltip"
           title="Nombre del segundo autorizador del banco (Director Divisional)."></i>
      </label>
            <input type="text" name="nombre_director_divisional" id="nombre_director_divisional" class="form-control" required
             value="{{ session.get('nombre_director_divisional') or '' }}">
    </div>
    <div class="col-md-6">
      <label for="puesto_director_divisional" class="form-label">
        Puesto <span class="text-danger">*</span>
        <i class="bi bi-info-circle-fill text-primary ms-1" data-bs-toggle="tooltip"
           title="Cargo o puesto del segundo autorizador."></i>
      </label>      
      <input type="text" name="puesto_director_divisional" id="puesto_director_divisional" class="form-control" required
             value="{{ session.get('puesto_director_divisional') or '' }}">
    </div>
  </div>
</form>
{% endif %}

{% if not imprimir_pdf %}
<!-- ===== ACCIONES ===== -->
<form method="POST" class="mt-4" id="formAcciones">
  <div class="border rounded p-3 mb-3" style="background-color: #f9f9f9;">
    <h5 class="mb-2">Opciones de impresi√≥n</h5>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="checkAnexoUSD" name="anexo_usd_14k" value="1"
             {% if session.get('anexo_usd_14k') %}checked{% endif %}>
      <label class="form-check-label" for="checkAnexoUSD">
        Incluir Anexo USD 14K en el PDF final
      </label>
    </div>
  </div>

  {% if session.get('rdc_reporte') %}
  <div class="alert alert-info my-3">
    Este cliente solicit√≥ cobro CENTRALIZADO. Se incluir√° el reporte Reporte Centralizado de Difencias (RDC) para el tr√°mite.
  </div>
  {% endif %}

  <div class="d-flex flex-wrap gap-2 mb-3">
    <button type="button" class="btn btn-outline-secondary"
    onclick="confirmExitTo('{{ url_for('solicitudes_portal.lista') }}')">
    ‚Üê Volver al panel
    </button>

    <!-- NUEVO: Confirmar firmantes con JS -->
    <button type="button" id="btnConfirmarFirmantes" class="btn btn-success">
      ‚úÖ Validar
    </button>

    <!-- Exportar PDF -->
    <button type="button" onclick="validarFirmantes()" class="btn btn-outline-primary">
      üìÑ Exportar ZIP
    </button>

    <!-- Guardar en BD (habilita s√≥lo si firmantes_confirmados en sesi√≥n) -->
    {% set listo = session.get('firmantes_confirmados') %}
    <button type="submit" name="guardar_todo" value="1"
            class="btn btn-primary"
            {% if not listo %}disabled title="Confirma firmantes para habilitar el guardado"{% endif %}>
      üíæ Guardar
    </button>
  </div>

  <div class="alert alert-info" role="alert">
    Al seleccionar <strong>Exportar PDF</strong>, se descargar√° un archivo <code>.zip</code> que contendr√° todos los documentos aplicables al tr√°mite.
  </div>

  <!-- Espacios ocultos para enviar firmantes con cualquier submit de este form -->
  <input type="hidden" name="apoderado_legal">
  <input type="hidden" name="fecha_firma">
  <input type="hidden" name="nombre_autorizador">
  <input type="hidden" name="puesto_autorizador">
  <input type="hidden" name="nombre_director_divisional">
  <input type="hidden" name="puesto_director_divisional">
</form>
{% endif %}

{% if imprimir_pdf %}
<!-- Nada extra aqu√≠ -->
{% endif %}

<!-- ===== JS ===== -->
<script>
  // Copia los campos visibles al form de acciones (inputs hidden)
  function syncFirmantesToHidden() {
    const formAcciones = document.getElementById('formAcciones');
    if (!formAcciones) return;
    const get = id => (document.getElementById(id)?.value || '').trim();
    formAcciones.querySelector('input[name="apoderado_legal"]').value = get('apoderado_legal');
    formAcciones.querySelector('input[name="fecha_firma"]').value = get('fecha_firma');
    formAcciones.querySelector('input[name="nombre_autorizador"]').value = get('nombre_autorizador');
    formAcciones.querySelector('input[name="puesto_autorizador"]').value = get('puesto_autorizador');
    formAcciones.querySelector('input[name="nombre_director_divisional"]').value = get('nombre_director_divisional');
    formAcciones.querySelector('input[name="puesto_director_divisional"]').value = get('puesto_director_divisional');
  }

  // Acci√≥n del bot√≥n Confirmar firmantes:
  // valida, copia a hidden, inyecta name=confirmar_firmantes y env√≠a el formAcciones
  document.addEventListener('DOMContentLoaded', function () {
    const btn = document.getElementById('btnConfirmarFirmantes');
    const formAcciones = document.getElementById('formAcciones');
    if (!btn || !formAcciones) return;

    btn.addEventListener('click', function () {
      const get = id => (document.getElementById(id)?.value || '').trim();
      const apoderado  = get('apoderado_legal');
      const fechaFirma = get('fecha_firma');
      const aut1       = get('nombre_autorizador');
      const pto1       = get('puesto_autorizador');
      const aut2       = get('nombre_director_divisional');
      const pto2       = get('puesto_director_divisional');

      if (!apoderado || !fechaFirma || !aut1 || !pto1 || !aut2 || !pto2) {
        alert('Completa todos los campos de firmantes antes de confirmar.');
        return;
      }

      // Copia a hidden
      syncFirmantesToHidden();

      // Inyecta el flag "confirmar_firmantes=1" antes de enviar
      let flag = formAcciones.querySelector('input[name="confirmar_firmantes"]');
      if (!flag) {
        flag = document.createElement('input');
        flag.type = 'hidden';
        flag.name = 'confirmar_firmantes';
        flag.value = '1';
        formAcciones.appendChild(flag);
      } else {
        flag.value = '1';
      }

      formAcciones.submit();
    });

    // Si el usuario hace submit por otros medios, sincroniza hidden
    formAcciones.addEventListener('submit', syncFirmantesToHidden);
  });
</script>

<script>
  // Exportar PDF: exige que los 6 campos tengan datos
  function validarFirmantes() {
    const apoderado  = (document.getElementById('apoderado_legal')?.value || '').trim();
    const fechaFirma = (document.getElementById('fecha_firma')?.value || '').trim();
    const aut1       = (document.getElementById('nombre_autorizador')?.value || '').trim();
    const pto1       = (document.getElementById('puesto_autorizador')?.value || '').trim();
    const aut2       = (document.getElementById('nombre_director_divisional')?.value || '').trim();
    const pto2       = (document.getElementById('puesto_director_divisional')?.value || '').trim();
    const anexoUSD   = document.getElementById('checkAnexoUSD')?.checked ? "1" : "";

    if (!apoderado || !fechaFirma || !aut1 || !pto1 || !aut2 || !pto2) {
      alert('Completa todos los campos de firmantes antes de exportar el PDF.');
      return;
    }

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{{ url_for('exportar.exportar_pdf') }}";
    [['apoderado_legal', apoderado],
     ['fecha_firma', fechaFirma],
     ['nombre_autorizador', aut1],
     ['puesto_autorizador', pto1],
     ['nombre_director_divisional', aut2],
     ['puesto_director_divisional', pto2],
     ['anexo_usd_14k', anexoUSD]
    ].forEach(([name, value]) => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = name;
      input.value = value;
      form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
  }
</script>

<!-- Flatpickr + Inputmask para Fecha -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/inputmask/5.0.8/inputmask.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const fechaInput = document.getElementById('fecha_firma');
  const errorDiv = document.getElementById('error_fecha');

  if (window.flatpickr) {
    flatpickr(fechaInput, {
      dateFormat: "d/m/Y",
      allowInput: true,
      locale: {
        firstDayOfWeek: 1,
        weekdays: { shorthand: ['Do','Lu','Ma','Mi','Ju','Vi','Sa'], longhand: ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'] },
        months:   { shorthand: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
                    longhand:  ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'] }
      }
    });
  }

  Inputmask("99/99/9999", { placeholder: "dd/mm/aaaa", showMaskOnHover: false, clearIncomplete: true }).mask(fechaInput);

  fechaInput.addEventListener('blur', function () {
    const v = this.value;
    if (v.length !== 10) { errorDiv.style.display='block'; this.classList.add('is-invalid'); return; }
    const [d,m,y] = v.split('/').map(Number);
    const dt = new Date(y, m-1, d);
    const ok = dt.getFullYear()===y && (dt.getMonth()+1)===m && dt.getDate()===d;
    errorDiv.style.display = ok ? 'none' : 'block';
    this.classList.toggle('is-invalid', !ok);
    this.classList.toggle('is-valid', ok);
  });

  fechaInput.addEventListener('input', function () {
    errorDiv.style.display = "none";
    this.classList.remove("is-invalid","is-valid");
  });
});
</script>

{% endblock %}
