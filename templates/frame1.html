{% extends "base.html" %}
{% block content %}
<div class="form-compact">
  <h2 class="mb-2">Nueva solicitud</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST" autocomplete="off">
    {# >>> FIX: bandera para la regla (1) RDC en exportar <<< #}
    <input type="hidden" name="incluir_rdc" id="incluir_rdc" value="NO">
    <input type="hidden" id="unidades_count"  value="{{ unidades|length if unidades is defined and unidades else 0 }}">
    <input type="hidden" id="cuentas_count"   value="{{ cuentas|length  if cuentas  is defined and cuentas  else 0 }}">
    <input type="hidden" id="usuarios_count"  value="{{ usuarios|length if usuarios is defined and usuarios else 0 }}">
    <input type="hidden" id="contactos_count" value="{{ contactos|length if contactos is defined and contactos else 0 }}">
    <input type="hidden" name="config_changed" id="config_changed" value="NO">


    <fieldset class="border p-3 mb-3 compact">
      <legend class="float-none w-auto px-2">Datos del Cliente</legend>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Tipo de Trámite *</label>
          <select class="form-select uc" name="tipo_tramite" id="tipo_tramite" required>
            <option value="">Selecciona...</option>
            <option value="ALTA" {% if frame1 and frame1.tipo_tramite == 'ALTA' %}selected{% endif %}>ALTA</option>
            <option value="SUSTITUCIÓN" {% if frame1 and frame1.tipo_tramite == 'SUSTITUCIÓN' %}selected{% endif %}>SUSTITUCIÓN</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Segmento *</label>
          <select class="form-select uc" name="segmento" required>
            <option value="">Selecciona…</option>
            <option value="EMPRESARIAL" {% if frame1 and frame1.segmento == 'EMPRESARIAL' %}selected{% endif %}>EMPRESARIAL</option>
            <option value="COMERCIAL" {% if frame1 and frame1.segmento == 'COMERCIAL' %}selected{% endif %}>COMERCIAL</option>
            <option value="OTRO" {% if frame1 and frame1.segmento == 'OTRO' %}selected{% endif %}>OTRO</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Nombre del Ejecutivo *</label>
          <input type="text" class="form-control uc" name="nombre_ejecutivo" required value="{{ frame1.nombre_ejecutivo if frame1 else '' }}">
        </div>
        <div class="col-md-6">
          <label class="form-label">Tipo Persona Cliente*</label>
          <select class="form-select uc" name="tipo_persona" id="tipo_persona">
            <option value="">Selecciona…</option>
            <option value="PERSONA MORAL" {% if frame1 and frame1.tipo_persona == 'PERSONA MORAL' %}selected{% endif %}>PERSONA MORAL</option>
            <option value="PERSONA FISICA CON ACTIVIDAD EMPRESARIAL" {% if frame1 and frame1.tipo_persona == 'PERSONA FISICA CON ACTIVIDAD EMPRESARIAL' %}selected{% endif %}>PERSONA FISICA CON ACTIVIDAD EMPRESARIAL</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Número Cliente *</label>
          <input type="text" class="form-control input-digit" name="numero_cliente" id="numero_cliente"
                 maxlength="11" value="{{ frame1.numero_cliente if frame1 else '' }}">
        </div>
        <div class="col-md-6">
          <label class="form-label">Nombre o Razón Social *</label>
          <input type="text" class="form-control uc" name="razon_social" required value="{{ frame1.razon_social if frame1 else '' }}">
        </div>
        <div class="col-md-6" id="grupo_contrato">
          <label class="form-label">Número de Contrato</label>
          <input type="text" class="form-control input-digit" name="numero_contrato" id="numero_contrato"
                 maxlength="12" value="{{ frame1.numero_contrato if frame1 else '' }}">
        </div>
        <div class="col-md-6">
          <label for="apoderado_legal" class="form-label">Apoderado Legal (Cliente) *</label>
          <input type="text" name="apoderado_legal" id="apoderado_legal" class="form-control uc"
                 value="{{ frame1.apoderado_legal if frame1 else '' }}">
        </div>
        <div class="col-md-6">
          <label class="form-label">Correo electrónico Apoderado Legal *</label>
          <input type="email" class="form-control" name="correo_apoderado_legal" required
                 value="{{ frame1.correo_apoderado_legal if frame1 else '' }}">
        </div>
        <div class="col-md-6">
          <label for="telefono_cliente" class="form-label">Teléfono del Cliente *</label>
          <input type="tel" name="telefono_cliente" id="telefono_cliente" class="form-control input-digit"
                 value="{{ frame1.telefono_cliente if frame1 else '' }}">
        </div>
        <div class="col-md-12">
          <label for="domicilio_cliente" class="form-label">Domicilio principal del Cliente *</label>
          <input type="text" name="domicilio_cliente" id="domicilio_cliente" class="form-control uc"
                 value="{{ frame1.domicilio_cliente if frame1 else '' }}">
        </div>
      </div>
    </fieldset>

    <fieldset class="border p-3 mb-3 compact">
      <legend class="float-none w-auto px-2">Servicio</legend>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Tipo Contrato *</label>
          <select class="form-select uc" name="tipo_contrato" id="tipo_contrato" required>
            <option value="">Selecciona…</option>
            <option value="CPAE TRADICIONAL" {% if frame1 and frame1.tipo_contrato == 'CPAE TRADICIONAL' %}selected{% endif %}>CPAE TRADICIONAL</option>
            <option value="SEF ELECTRÓNICO" {% if frame1 and frame1.tipo_contrato == 'SEF ELECTRÓNICO' %}selected{% endif %}>SEF ELECTRÓNICO</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Servicio *</label>
          <select class="form-select uc" name="tipo_servicio" id="tipo_servicio" required>
            <option value="">Selecciona...</option>
            <option value="DEPÓSITO TRADICIONAL" {% if frame1 and frame1.tipo_servicio == 'DEPÓSITO TRADICIONAL' %}selected{% endif %}>DEPÓSITO TRADICIONAL</option>
            <option value="DEPÓSITO ELECTRÓNICO" {% if frame1 and frame1.tipo_servicio == 'DEPÓSITO ELECTRÓNICO' %}selected{% endif %}>DEPÓSITO ELECTRÓNICO</option>
            <option value="DOTACIÓN ELECTRÓNICA" {% if frame1 and frame1.tipo_servicio == 'DOTACIÓN ELECTRÓNICA' %}selected{% endif %}>DOTACIÓN ELECTRÓNICA</option>
            <option value="DEPÓSITO ELECTRÓNICO Y DOTACIÓN ELECTRÓNICA" {% if frame1 and frame1.tipo_servicio == 'DEPÓSITO ELECTRÓNICO Y DOTACIÓN ELECTRÓNICA' %}selected{% endif %}>DEPÓSITO ELECTRÓNICO Y DOTACIÓN ELECTRÓNICA</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Tipo de Cobro *</label>
          {# >>> FIX: id=\"tipo_cobro\" para la regla (1) y compatibilidad con scripts previos <<< #}
          <select class="form-select uc" name="tipo_cobro" id="tipo_cobro" required>
            <option value="">Selecciona…</option>
            <option {% if frame1 and frame1.tipo_cobro == 'LOCAL' %}selected{% endif %}>LOCAL</option>
            <option {% if frame1 and frame1.tipo_cobro == 'CENTRALIZADO' %}selected{% endif %}>CENTRALIZADO</option>
          </select>
        </div>
        <div class="col-md-6" id="importe_dif_grupo" style="display: none;">
          <label class="form-label">Importe Máximo de Diferencias *</label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            <input type="text" class="form-control input-digit" name="importe_maximo_dif" id="importe_maximo_dif"
                   value="{{ '{:,.2f}'.format(frame1.importe_maximo_dif|float) if frame1 and frame1.importe_maximo_dif else '200.01' }}">
          </div>
        </div>
      </div>
    </fieldset>

    <button type="submit" class="btn btn-primary">Guardar y Continuar</button>

    <!-- Modal: cambio de configuración -->
<div class="modal fade" id="modalConfigChange" tabindex="-1" aria-labelledby="modalConfigChangeLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalConfigChangeLabel">Cambiar configuración del servicio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        Has modificado la configuración (<strong>Tipo de trámite / Tipo de contrato / Tipo de servicio</strong>).
        <br>Los registros previamente capturados de <strong>Unidades, Cuentas, Usuarios y Contactos</strong>
        serán <strong>eliminados</strong> al guardar esta solicitud.
        <br><br>¿Deseas continuar?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" id="btnConfigCancelar" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="btnConfigContinuar" data-bs-dismiss="modal">Sí, continuar</button>
      </div>
    </div>
  </div>
</div>

  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const $ = (sel) => document.querySelector(sel);
    // Normaliza robusto: sin acentos, mayúsculas
    const normaliza = (s) => (s || '')
      .toString()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .toUpperCase();
  
    const tipoTramite   = $('#tipo_tramite');
    const tipoContrato  = $('#tipo_contrato');
    const tipoServicio  = $('#tipo_servicio');
    const grupoContrato = $('#grupo_contrato');
    const numContrato   = $('#numero_contrato');
    const numCliente    = $('#numero_cliente');
    const tipoCobro     = $('#tipo_cobro');
    const impDifGrupo   = $('#importe_dif_grupo');
    const impDifInput   = $('#importe_maximo_dif');
    const incluirRdc    = $('#incluir_rdc');
  
    // Contadores (si existen datos ya capturados)
    const unidadesCount  = parseInt($('#unidades_count')?.value || '0', 10);
    const cuentasCount   = parseInt($('#cuentas_count')?.value  || '0', 10);
    const usuariosCount  = parseInt($('#usuarios_count')?.value || '0', 10);
    const contactosCount = parseInt($('#contactos_count')?.value|| '0', 10);
    const hayDatosPrevios = (unidadesCount + cuentasCount + usuariosCount + contactosCount) > 0;
  
    // Valores originales para revertir si el usuario cancela en el modal
    let origTipoTramite  = tipoTramite?.value || '';
    let origTipoContrato = tipoContrato?.value || '';
    let origTipoServicio = tipoServicio?.value || '';
  
    // ===== Regla (8): mayúsculas en textos (excepto emails) =====
    document.querySelectorAll('input[type="text"], textarea').forEach(function(inp){
      if (inp.type === 'email' || (inp.name && inp.name.includes('correo'))) return;
      inp.addEventListener('input', function(){
        const pos = inp.selectionStart;
        inp.value = inp.value.toUpperCase();
        try { inp.setSelectionRange(pos, pos); } catch(e){}
      });
    });
  
    // ===== Reglas (5) y (6): numéricos con longitudes =====
    numCliente && numCliente.addEventListener('input', function(){
      this.value = this.value.replace(/\D/g,'').slice(0,11);
    }, {passive:true});
  
    numContrato && numContrato.addEventListener('input', function(){
      this.value = this.value.replace(/\D/g,'').slice(0,12);
    }, {passive:true});
  
    // ===== Regla (2): trámite controla contrato =====
    function reglaTramite(){
      const v = tipoTramite?.value || '';
      if (v === 'ALTA') {
        if (grupoContrato) grupoContrato.style.display = 'none';
        if (numContrato) { numContrato.removeAttribute('required'); numContrato.value = ''; }
      } else if (v === 'SUSTITUCIÓN') {
        if (grupoContrato) grupoContrato.style.display = '';
        if (numContrato) numContrato.setAttribute('required','required');
      }
    }
  
    // ===== Regla (3): contrato restringe servicio =====
    function reglaContrato(){
      const v = normaliza(tipoContrato?.value);
      const permitidoCPAE = ['DEPÓSITO TRADICIONAL'];
      const permitidoSEF  = ['DEPÓSITO ELECTRÓNICO','DOTACIÓN ELECTRÓNICA','DEPÓSITO ELECTRÓNICO Y DOTACIÓN ELECTRÓNICA'];
  
      const opcionesValidas = (v === 'CPAE TRADICIONAL')
        ? permitidoCPAE
        : (v === 'SEF ELECTRONICO' || v === 'SEF ELECTRÓNICO')
          ? permitidoSEF
          : [];
  
      if (tipoServicio) {
        Array.from(tipoServicio.options).forEach(opt => {
          if (opt.value === '') return; // placeholder
          const esValida = opcionesValidas.includes(opt.value);
          opt.disabled = !esValida;
          opt.style.display = esValida ? 'block' : 'none';
        });
        // si la selección actual quedó inválida, vaciar
        if (tipoServicio.value && !opcionesValidas.includes(tipoServicio.value)) {
          tipoServicio.value = '';
        }
      }
      // Cascada hacia la regla (4)
      reglaServicio();
    }
  
    // ===== Regla (4): mostrar/ocultar Importe Máximo de Diferencias =====
    const serviciosQueMuestranImporte = new Set([
      'DEPOSITO TRADICIONAL',
      'DEPOSITO ELECTRONICO',
      'DEPOSITO ELECTRONICO Y DOTACION ELECTRONICA'
    ]);
  
    function reglaServicio(){
      const vNorm = normaliza(tipoServicio?.value);
      const debe  = serviciosQueMuestranImporte.has(vNorm);
  
      if (impDifGrupo) impDifGrupo.style.display = debe ? '' : 'none';
  
      if (impDifInput) {
        if (debe) {
          impDifInput.setAttribute('required','required');
          // (1) valor por defecto 200.01 si viene vacío (editable por el usuario)
          if (!impDifInput.value || impDifInput.value.trim() === '') {
            impDifInput.value = '200.01';
          }
        } else {
          impDifInput.removeAttribute('required');
          // opcional: no vaciamos para no perder entrada del usuario si oculta temporalmente
          // impDifInput.value = '';
        }
      }
    }
  
    // ===== Regla (1): cobro centralizado -> bandera RDC =====
    function reglaCobro(){
      const v = normaliza(tipoCobro?.value);
      if (incluirRdc) incluirRdc.value = (v === 'CENTRALIZADO') ? 'SI' : 'NO';
    }
  
    // ===== Modal de advertencia por cambio de configuración (punto 2) =====
    const modalEl   = document.getElementById('modalConfigChange');
    const modalInst = modalEl ? new bootstrap.Modal(modalEl) : null;
    const btnOk     = document.getElementById('btnConfigContinuar');
    const btnCancel = document.getElementById('btnConfigCancelar');
    const cfgChanged= document.getElementById('config_changed');
  
    // util: muestra modal sólo si hay datos previos
    function confirmarCambioConfig(onConfirm, onCancel){
      if (!hayDatosPrevios || !modalInst) { onConfirm(); return; }
      // limpiar listeners previos (por seguridad)
      if (btnOk)     btnOk.onclick = null;
      if (btnCancel) btnCancel.onclick = null;
  
      modalInst.show();
      btnOk && (btnOk.onclick = function(){
        if (cfgChanged) cfgChanged.value = 'SI';
        modalInst.hide();
        onConfirm && onConfirm();
      });
      btnCancel && (btnCancel.onclick = function(){
        modalInst.hide();
        onCancel && onCancel();
      });
    }
  
    // Listeners con confirmación
    tipoTramite && tipoTramite.addEventListener('change', function (e) {
      const nuevo = tipoTramite.value;
      confirmarCambioConfig(
        () => { // confirmar
          origTipoTramite = nuevo;
          reglaTramite();
        },
        () => { // cancelar -> revertir
          tipoTramite.value = origTipoTramite;
          reglaTramite();
        }
      );
    });
  
    tipoContrato && tipoContrato.addEventListener('change', function (e) {
      const nuevo = tipoContrato.value;
      confirmarCambioConfig(
        () => { // confirmar
          origTipoContrato = nuevo;
          reglaContrato();
        },
        () => { // cancelar -> revertir
          tipoContrato.value = origTipoContrato;
          reglaContrato();
        }
      );
    });
  
    tipoServicio && tipoServicio.addEventListener('change', function (e) {
      const nuevo = tipoServicio.value;
      confirmarCambioConfig(
        () => { // confirmar
          origTipoServicio = nuevo;
          reglaServicio();
        },
        () => { // cancelar -> revertir
          tipoServicio.value = origTipoServicio;
          reglaServicio();
        }
      );
    });
  
    // Bind “normales”
    tipoCobro  && tipoCobro.addEventListener('change',  reglaCobro);
  
    // Estado inicial (si hay valores precargados)
    reglaTramite();
    reglaContrato();
    reglaServicio();
    reglaCobro();
  });
  </script>
  
  
{% endblock %}
