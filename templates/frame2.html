{% extends "base.html" %}

{% block title %}Unidades de Negocio{% endblock %}

{% block content %}

<!-- ===== RESUMEN DE LA SOLICITUD ===== -->
<div class="card shadow-sm mb-4 border-0">
  <div class="card-header d-flex align-items-center justify-content-between" style="background:#003746; color:#fff;">
    <div class="d-flex align-items-center gap-2">
      <strong>Resumen de la solicitud</strong>
    </div>
    <a href="{{ url_for('frames.frame1') }}" class="btn btn-outline-light btn-sm">✎ Editar</a>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0 align-middle">
        <tbody>
          <tr>
            <th class="text-muted fw-semibold" style="width:18%">Cliente</th>
            <td style="width:32%">{{ frame1.numero_cliente }} - {{ frame1.razon_social }}</td>
            <th class="text-muted fw-semibold" style="width:18%">Segmento</th>
            <td style="width:32%">{{ frame1.segmento or '-' }}</td>
          </tr>
          <tr>
            <th class="text-muted fw-semibold">Contrato</th>
            <td>{{ frame1.numero_contrato or '-' }}</td>
            <th class="text-muted fw-semibold">Tipo Trámite</th>
            <td>{{ frame1.tipo_tramite or '-' }}</td>
          </tr>
          <tr>
            <th class="text-muted fw-semibold">Tipo Contrato</th>
            <td>{{ frame1.tipo_contrato or '-' }}</td>
            <th class="text-muted fw-semibold">Servicio</th>
            <td id="servicio_general">{{ frame1.tipo_servicio or '-' }}</td>
          </tr>
          <tr>
            <th class="text-muted fw-semibold">Tipo Cobro Comisión</th>
            <td>{{ frame1.tipo_cobro or '-' }}</td>
            <th class="text-muted fw-semibold">Importe Máximo de Diferencias</th>
            <td>{{ frame1.importe_maximo_dif or '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== FORMULARIO: UNIDADES ===== -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-header d-flex align-items-center gap-2" style="background:#F7FBFD; color:#003746;">
    <h2 class="h5 mb-0 d-flex align-items-center gap-2">
      <i class="bi bi-building"></i>
      <span>Captura de Unidades</span>
    </h2>
  </div>

  <div class="card-body">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" class="needs-validation" novalidate autocomplete="off">
      <!-- Contexto/ocultos -->
      <input type="hidden" id="servicio_tipo_oculto" value="{{ frame1.tipo_servicio }}">
      <input type="hidden" name="origen_unidad" id="origen_unidad" value="">

      <!-- ocultos para enviar tambien los nombres de catálogo -->
      <input type="hidden" name="cpae_nombre" id="cpae_nombre" value="">
      <input type="hidden" name="estado_nombre" id="estado_nombre" value="">
      <input type="hidden" name="municipio_nombre" id="municipio_nombre" value="">
      <input type="hidden" name="etv_nombre" id="etv_nombre" value="">

      {% if frame1.tipo_tramite == "SUSTITUCIÓN" %}
      <div class="row g-3 mb-2">
        <div class="col-12">
          <label class="form-label">¿Qué desea hacer?</label>
        </div>
        <div class="col-md-6">
          <label class="form-label">
            Tipo de movimiento *
            <i class="bi bi-info-circle-fill text-primary ms-1"
               data-bs-toggle="tooltip" title="Selecciona si es ALTA, MODIFICACIÓN o BAJA."></i>
          </label>
          <select class="form-select uc" name="tipo_movimiento" id="tipo_movimiento" required>
            <option value="">Selecciona…</option>
            <option value="ALTA">ALTA</option>
            <option value="MODIFICACIÓN">MODIFICACIÓN</option>
            <option value="BAJA">BAJA</option>
          </select>
        </div>
        <div class="col-md-6" id="grupo_campo_mod_unidad" style="display:none;">
          <label class="form-label">Campo a modificar</label>
          <select id="campo_mod_unidad" name="campo_mod_unidad" class="form-select">
            <option value="">Selecciona…</option>
            <option value="NOMBRE_UNIDAD">NOMBRE UNIDAD DE NEGOCIO</option>
            <option value="CPAE">CPAE</option>
            <option value="SERVICIO_UNIDAD">SERVICIO DE LA UNIDAD</option>
            <option value="ETV">EMPRESA DE TRASLADO DE VALORES</option>
            <option value="DOMICILIO">DOMICILIO</option>
            <option value="TERM_INTEG">NO. TERMINAL INTEGRADORA</option>
            <option value="TERM_DOT_CENT">NO. TERMINAL DOTACIÓN CENTRALIZADA</option>
            <option value="TERM_CERT_CENT">NO. TERMINAL CLIENTE CERTIFICADO</option>
          </select>
          <div class="form-text">Selecciona el dato específico que vas a cambiar.</div>
        </div>
      </div>
      {% endif %}

      <!-- No. Terminal SEF -->
      <div class="row g-3" id="grupo_terminal">
        <div class="col-md-6">
          <label class="form-label">
            Número de Terminal SEF
            <i class="bi bi-info-circle-fill text-primary ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
               title="10 dígitos numéricos. Obligatorio en MODIFICACIÓN y BAJA."></i>
          </label>
          <input type="text" class="form-control input-digit" id="numero_terminal_sef" name="numero_terminal_sef" maxlength="10" placeholder="Ej. 0001234567">
        </div>
      </div>

      <!-- Nombre Unidad -->
      <div class="row g-3 mt-0" id="grupo_nombre_unidad">
        <div class="col-md-8">
          <label class="form-label">
            Nombre de la Unidad *
            <i class="bi bi-info-circle-fill text-primary ms-1" data-bs-toggle="tooltip" title="Nombre asignado por el Cliente para identificar la Unidad."></i>
          </label>
          <input type="text" class="form-control uc" name="nombre_unidad" id="nombre_unidad" placeholder="Ej. Sucursal Centro">
        </div>
      </div>

      <hr class="text-muted"/>

      <!-- Datos principales -->
      <div class="row g-3">
        <div class="col-lg-4">
          <label class="form-label">CPAE *</label>
          <select class="form-select" name="cpae" required id="cpaeSelect">
            <option value="">Selecciona…</option>
            {% for cpae in catalogo_cpae %}
              <option value="{{ cpae.id }}">{{ cpae.descripcion }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-lg-4">
          <label class="form-label">Servicio en la Unidad *</label>
          <select class="form-select" name="tipo_servicio_unidad" id="tipo_servicio_unidad" required>
            <option value="">Selecciona…</option>
            <option value="DEPÓSITO TRADICIONAL">DEPÓSITO TRADICIONAL</option>
            <option value="DEPÓSITO ELECTRÓNICO">DEPÓSITO ELECTRÓNICO</option>
            <option value="DOTACIÓN ELECTRÓNICA">DOTACIÓN ELECTRÓNICA</option>
            <option value="DEPÓSITO ELECTRÓNICO Y DOTACIÓN ELECTRÓNICA">DEPÓSITO ELECTRÓNICO Y DOTACIÓN ELECTRÓNICA</option>
            <option value="CENTRALIZADA (SOLO DOTACIÓN)">CENTRALIZADA (SOLO DOTACIÓN)</option>
            <option value="INTEGRADORA (SOLO DEPÓSITO)">INTEGRADORA (SOLO DEPÓSITO)</option>
            <option value="DEPOSITO CLIENTE CERTIFICADO">DEPOSITO CLIENTE CERTIFICADO</option>
            <option value="CENTRALIZADA CLIENTE CERTIFICADO">CENTRALIZADA CLIENTE CERTIFICADO</option>
          </select>
        </div>

        <div class="col-lg-4">
          <label class="form-label">Empresa de Traslado de Valores *</label>
          <select class="form-select" name="empresa_traslado" id="empresa_traslado" required>
            <option value="">SELECCIONA...</option>
            {% for etv in catalogo_etv %}
              <option value="{{ etv.id }}">{{ etv.descripcion }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Dirección -->
      <div class="row g-3 mt-1">
        <div class="col-md-4">
          <label class="form-label">Calle y número *</label>
          <input type="text" class="form-control uc" name="calle_numero" id="calle_numero" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Colonia *</label>
          <input type="text" class="form-control uc" name="colonia" id="colonia" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Código Postal *</label>
          <input type="text" class="form-control input-digit cp-5" name="codigo_postal" id="codigo_postal" maxlength="5" required>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <label class="form-label">Estado *</label>
          <select class="form-select" name="estado" id="estadoSelect" required>
            <option value="">Selecciona…</option>
            {% for estado in catalogo_estados %}
              <option value="{{ estado.id }}">{{ estado.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Ciudad/Municipio *</label>
          <select class="form-select" name="municipio_id" id="municipioSelect" required>
            <option value="">Selecciona...</option>
          </select>
        </div>
      </div>

      <!-- Terminales relacionadas -->
      <div class="row g-3 mt-1">
        <div class="col-md-4">
          <label class="form-label">No. Terminal Integradora</label>
          <input type="text" class="form-control uc" name="terminal_integradora" id="terminal_integradora">
        </div>
        <div class="col-md-4">
          <label class="form-label">No. Terminal Dotación Centralizada</label>
          <input type="text" class="form-control uc" name="terminal_dotacion_centralizada" id="terminal_dotacion_centralizada">
        </div>
        <div class="col-md-4">
          <label class="form-label">No. Terminal Cliente Certificado Centralizada</label>
          <input type="text" class="form-control uc" name="terminal_certificado_centralizada" id="terminal_certificado_centralizada">
        </div>
      </div>

      {# === Botonera: depende de si hay acción en UNIDADES desde frame1 === #}
      {% set es_sust = frame1 and (frame1.tipo_tramite in ['SUSTITUCIÓN','SUSTITUCION']) %}
      {% set marco_mod_unidades  = es_sust and frame1.sust_mod  and ('UNIDADES' in frame1.sust_mod) %}
      {% set marco_crea_unidades = es_sust and frame1.sust_crea and ('UNIDADES' in frame1.sust_crea) %}
      {% set sin_accion_unidades = es_sust and (not marco_mod_unidades) and (not marco_crea_unidades) %}
      
      <div class="d-flex gap-2 mt-3">
        <button type="submit" name="regresar_frame1" value="1" class="btn btn-outline-secondary btn-sm">
          ← Regresar
        </button>
      
        {% if sin_accion_unidades %}
          <a href="{{ url_for('frames.frame3') }}" class="btn btn-primary btn-sm">
            Siguiente — Cuentas →
          </a>
        {% else %}
          <button type="submit" name="agregar" value="1" class="btn btn-primary btn-sm">
            Guardar Unidad
          </button>
          <a href="{{ url_for('frames.frame3') }}" class="btn btn-outline-primary btn-sm">
            Siguiente — Cuentas →
          </a>
        {% endif %}
      </div>
      
      </div>
    </form>
  </div>
</div>

<!-- ===== UNIDADES CAPTURADAS ===== -->
<div class="card shadow-sm border-0">
  <div class="card-header bg-white d-flex align-items-center justify-content-between">
    <h3 class="h6 mb-0">Unidades Capturadas</h3>
    {% if unidades %}
      <form method="GET" action="{{ url_for('frames.frame3') }}" class="mb-0">
        <button type="submit" class="btn btn-primary btn-sm">Siguiente – Cuentas</button>
      </form>
    {% endif %}
  </div>
  <div class="card-body">
    {% if unidades %}
      <div class="accordion" id="accordionUnidades">
        {% for u in unidades %}
          <div class="accordion-item mb-2 border rounded-3">
            <h2 class="accordion-header" id="heading{{ loop.index }}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                      data-bs-target="#collapse{{ loop.index }}" aria-expanded="false"
                      aria-controls="collapse{{ loop.index }}">
                <strong>#{{ loop.index }}</strong>
                &nbsp;– [{{ u.tipo_movimiento or 'ALTA' }}] {{ u.tipo_servicio_unidad or '-' }} | {{ u.cpae_nombre or '-' }} | SEF: {{ u.numero_terminal_sef or '-' }} | {{ u.nombre_unidad or '-' }}
              </button>
            </h2>
            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#accordionUnidades">
              <div class="accordion-body small">
                <div class="row g-2">
                  <div class="col-md-6"><strong>ETV:</strong> {{ u.etv_nombre or '-' }}</div>
                  <div class="col-md-6"><strong>Estado:</strong> {{ u.estado_nombre or '-' }}</div>
                  <div class="col-md-6"><strong>Municipio:</strong> {{ u.municipio_nombre or '-' }}</div>
                  <div class="col-md-6"><strong>C.P.:</strong> {{ u.codigo_postal or '-' }}</div>
                  <div class="col-md-6"><strong>Calle y Número:</strong> {{ u.calle_numero or '-' }}</div>
                  <div class="col-md-6"><strong>Colonia:</strong> {{ u.colonia or '-' }}</div>
                  <div class="col-md-6"><strong>Integradora:</strong> {{ u.terminal_integradora or '-' }}</div>
                  <div class="col-md-6"><strong>Dotación Centralizada:</strong> {{ u.terminal_dotacion_centralizada or '-' }}</div>
                  <div class="col-md-6"><strong>Certificado Centralizada:</strong> {{ u.terminal_certificado_centralizada or '-' }}</div>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-3">
                  <form method="POST" class="mb-0">
                    <input type="hidden" name="eliminar" value="{{ loop.index0 }}">
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                      <i class="bi bi-trash"></i> Eliminar
                    </button>
                  </form>
                </div>

              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted mb-0">Aún no se ha agregado ninguna unidad.</p>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    /* =========================
       0) Utilidades generales
       ========================= */
    const $  = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const req = (el,on)=>{ if(!el) return; on ? el.setAttribute('required','required') : el.removeAttribute('required'); };
    const ena = (el,on)=>{ if(!el) return; el.disabled = !on; };
    const show= (el,on)=>{ if(!el) return; el.style.display = on ? '' : 'none'; };
    const clr = (el)=>{ if(!el) return; el.tagName === 'SELECT' ? (el.value='', el.dispatchEvent(new Event('change',{bubbles:true}))) : (el.value=''); };
    const applyRulesEngine = ()=> window.RequiredRules?.applyRequiredRules?.(window.RequiredRules.getCurrentFormState?.());
  
    // Tooltips
    $$( '[data-bs-toggle="tooltip"]' ).forEach(el => new bootstrap.Tooltip(el));
  
    // Contexto de frame1
    const TIPO_TRAMITE = "{{ frame1.tipo_tramite }}";
    const esSust = (TIPO_TRAMITE === "SUSTITUCIÓN" || TIPO_TRAMITE === "SUSTITUCION");
    const sustMod  = {{ (frame1.sust_mod  or [])|tojson }};
    const sustCrea = {{ (frame1.sust_crea or [])|tojson }};
    const modUnidades  = Array.isArray(sustMod)  && sustMod.includes('UNIDADES');
    const creaUnidades = Array.isArray(sustCrea) && sustCrea.includes('UNIDADES');
  
    /* =========================
       1) Filtrar "Servicio en la Unidad"
          según servicio general del frame1
       ========================= */
    (function filtraServiciosUnidadPorServicioGeneral(){
      const servicioGeneral = ($('#servicio_tipo_oculto')?.value || '').trim();
      const selectServicioUnidad = $("#tipo_servicio_unidad");
      if (!selectServicioUnidad) return;
  
      const reglas = {
        "DEPÓSITO TRADICIONAL": ["DEPÓSITO TRADICIONAL"],
        "DEPÓSITO ELECTRÓNICO": [
          "DEPÓSITO ELECTRÓNICO",
          "INTEGRADORA (SOLO DEPÓSITO)",
          "DEPOSITO CLIENTE CERTIFICADO",
          "CENTRALIZADA CLIENTE CERTIFICADO"
        ],
        "DOTACIÓN ELECTRÓNICA": [
          "DOTACIÓN ELECTRÓNICA",
          "CENTRALIZADA (SOLO DOTACIÓN)"
        ],
        "DEPÓSITO ELECTRÓNICO Y DOTACIÓN ELECTRÓNICA": [
          "DEPÓSITO ELECTRÓNICO",
          "DOTACIÓN ELECTRÓNICA",
          "DEPÓSITO ELECTRÓNICO Y DOTACIÓN ELECTRÓNICA",
          "CENTRALIZADA (SOLO DOTACIÓN)",
          "INTEGRADORA (SOLO DEPÓSITO)",
          "DEPOSITO CLIENTE CERTIFICADO",
          "CENTRALIZADA CLIENTE CERTIFICADO"
        ]
      };
  
      const visibles = reglas[servicioGeneral] || [];
      const todas = Array.from(selectServicioUnidad.options);
      selectServicioUnidad.innerHTML = "";
      todas.forEach(opt => {
        if (opt.value === "" || visibles.includes(opt.value)) selectServicioUnidad.appendChild(opt);
      });
    })();
  
    /* =========================
       2) Reglas de terminales extra
          según "Servicio en la Unidad"
          + neutralización en BAJA
       ========================= */
    (function reglasTerminalesPorServicioUnidad(){
      const sel = $('#tipo_servicio_unidad');
      const tInt  = $('#terminal_integradora');
      const tDot  = $('#terminal_dotacion_centralizada');
      const tCert = $('#terminal_certificado_centralizada');

      function setDisabled(el, disabled, clear=false) {
        if (!el) return;
        el.disabled = !!disabled;
        if (disabled && clear) el.value = '';
      }
      function setRequired(el, required) {
        if (!el) return;
        if (required) el.setAttribute('required', 'required'); else el.removeAttribute('required');
      }
      function isBaja(){
        const mv = ($('#tipo_movimiento')?.value || '').toUpperCase();
        return mv === 'BAJA';
      }

      function aplicaReglas() {
        const v = (sel?.value || '').toUpperCase();

        // Si es BAJA, neutraliza terminales sí o sí
        if (isBaja()){
          setDisabled(tInt,  true, true);
          setDisabled(tDot,  true, true);
          setDisabled(tCert, true, true);
          setRequired(tCert, false);
          return;
        }

        // Reset
        setDisabled(tInt,  false);
        setDisabled(tDot,  false);
        setDisabled(tCert, false);
        setRequired(tCert, false);

        // CENTRALIZADA (SOLO DOTACIÓN)
        if (v.includes('CENTRALIZADA') && v.includes('SOLO DOTACIÓN')) {
          setDisabled(tDot,  true, true);
          setDisabled(tCert, true, true);
          setDisabled(tInt,  true, true);
          return;
        }
        // INTEGRADORA (SOLO DEPÓSITO)
        if (v.includes('INTEGRADORA') && v.includes('SOLO DEPÓSITO')) {
          setDisabled(tDot,  true, true);
          setDisabled(tCert, true, true);
          setDisabled(tInt,  true, true);
          return;
        }
        // CENTRALIZADA CLIENTE CERTIFICADO
        if (v === 'CENTRALIZADA CLIENTE CERTIFICADO') {
          setDisabled(tDot,  true, true);
          setDisabled(tCert, true, true);
          setDisabled(tInt,  true, true);
          return;
        }
        // DEPOSITO CLIENTE CERTIFICADO
        if (v === 'DEPOSITO CLIENTE CERTIFICADO' || v === 'DEPÓSITO CLIENTE CERTIFICADO') {
          setDisabled(tDot,  true, true);
          setDisabled(tInt,  true, true);
          setDisabled(tCert, false);
          setRequired(tCert, true);
          return;
        }
      }

      sel && sel.addEventListener('change', ()=>{aplicaReglas(); applyRulesEngine();});

      // Re-evaluar también cuando cambie el tipo de movimiento
      const selMov = $('#tipo_movimiento');
      selMov && selMov.addEventListener('change', ()=>{aplicaReglas(); applyRulesEngine();});

      aplicaReglas();
    })();
  
    /* =========================
       3) Estados/Municipios + nombres ocultos
       ========================= */
    (function wireEstadosMunicipios(){
      const estadoSelect = $('#estadoSelect');
      const municipioSelect = $('#municipioSelect');
      const cpaeSelect = $('#cpaeSelect');
      const etvSelect  = $('#empresa_traslado');
  
      const inpCpaeNombre = $('#cpae_nombre');
      const inpEstadoNombre = $('#estado_nombre');
      const inpMunicipioNombre = $('#municipio_nombre');
      const inpEtvNombre = $('#etv_nombre');
  
      function setHiddenFromSelect(selectEl, hiddenEl) {
        if (!selectEl || !hiddenEl) return;
        const txt = selectEl.options[selectEl.selectedIndex]?.textContent?.trim() || '';
        hiddenEl.value = txt;
      }
  
      cpaeSelect && cpaeSelect.addEventListener('change', () => setHiddenFromSelect(cpaeSelect, inpCpaeNombre));
      etvSelect  && etvSelect.addEventListener('change', () => setHiddenFromSelect(etvSelect, inpEtvNombre));
      estadoSelect && estadoSelect.addEventListener('change', () => {
        setHiddenFromSelect(estadoSelect, inpEstadoNombre);
  
        const estadoId = estadoSelect.value;
        municipioSelect.innerHTML = '<option value="">Cargando...</option>';
        municipioSelect.disabled = true;
  
        if (!estadoId) {
          municipioSelect.innerHTML = '<option value="">Selecciona el estado primero</option>';
          municipioSelect.disabled = true;
          return;
        }
  
        fetch(`/api/municipios?estado_id=${estadoId}`)
          .then(r => r.json())
          .then(resp => {
            const data = resp.data || [];
            municipioSelect.innerHTML = '<option value="">Selecciona…</option>';
            data.forEach(mun => {
              const option = document.createElement('option');
              option.value = mun.id;
              option.textContent = mun.nombre;
              municipioSelect.appendChild(option);
            });
            municipioSelect.disabled = false;
            if (inpMunicipioNombre) inpMunicipioNombre.value = '';
          })
          .catch(() => {
            municipioSelect.innerHTML = '<option value="">Error al cargar</option>';
          });
      });
  
      municipioSelect && municipioSelect.addEventListener('change', () => setHiddenFromSelect(municipioSelect, inpMunicipioNombre));
  
      // Iniciales
      setHiddenFromSelect(cpaeSelect, inpCpaeNombre);
      setHiddenFromSelect(etvSelect,  inpEtvNombre);
      setHiddenFromSelect(estadoSelect, inpEstadoNombre);
      setHiddenFromSelect(municipioSelect, inpMunicipioNombre);
    })();
  
    /* =========================
       4) Choices.js para CPAE
       ========================= */
    (function initChoicesCPAE(){
      const sel = $('#cpaeSelect');
      if (sel && window.Choices) {
        new Choices(sel, {
          searchEnabled: true,
          itemSelectText: '',
          placeholderValue: 'Escribe para buscar…',
          searchPlaceholderValue: 'Buscar CPAE…'
        });
      }
    })();
  
    /* =========================
       5) Lógica de Sustitución:
          ALTA / MODIFICACIÓN / BAJA
          + selector "Campo a modificar"
          + limpieza y requireds
          + modo sin acción en UNIDADES
       ========================= */
    (function sustitucionUnidadUI(){
      const selMov     = $('#tipo_movimiento');                 // ALTA/MODIFICACIÓN/BAJA
      const selCampo   = $('#campo_mod_unidad');                // selector de campo puntual
      const grupoCampo = $('#grupo_campo_mod_unidad');          // wrapper del selector
      const terminal   = $('#numero_terminal_sef');
      const origen     = $('#origen_unidad');
  
      // Nº terminal: solo dígitos
      terminal && terminal.addEventListener('input', function(){
        this.value = this.value.replace(/\D/g,'').slice(0,10);
      }, {passive:true});

      // Limpia un <select> y su campo espejo de texto (si existe)
      function clearSelectAndMirror(selectEl, mirrorEl){
        if (selectEl){
          selectEl.value = '';
          selectEl.dispatchEvent(new Event('change', { bubbles: true }));
        }
        if (mirrorEl){ mirrorEl.value = ''; }
      }
      // Espejos
      const MIR = {
        cpae_nombre:    document.getElementById('cpae_nombre'),
        estado_nombre:  document.getElementById('estado_nombre'),
        municipio_nombre: document.getElementById('municipio_nombre'),
        etv_nombre:     document.getElementById('etv_nombre')
      };
  
      // Campos gobernables
      const F = {
        nombre_unidad: $('#nombre_unidad'),
        cpaeSelect: $('#cpaeSelect'),
        tipo_servicio_unidad: $('#tipo_servicio_unidad'),
        empresa_traslado: $('#empresa_traslado'),
        // Domicilio
        calle_numero: $('#calle_numero'),
        colonia: $('#colonia'),
        codigo_postal: $('#codigo_postal'),
        estadoSelect: $('#estadoSelect'),
        municipioSelect: $('#municipioSelect'),
        // Terminales extra
        terminal_integradora: $('#terminal_integradora'),
        terminal_dotacion_centralizada: $('#terminal_dotacion_centralizada'),
        terminal_certificado_centralizada: $('#terminal_certificado_centralizada'),
        // Terminal clave
        numero_terminal_sef: terminal
      };
      const PACK_DOM = ['calle_numero','colonia','codigo_postal','estadoSelect','municipioSelect'];
      const ALTA_REQ = ['nombre_unidad','cpaeSelect','tipo_servicio_unidad','empresa_traslado', ...PACK_DOM];
  
      const ALL_KEYS = Object.keys(F);
  
      function disableAll(removeReq=true){
        ALL_KEYS.forEach(k => { ena(F[k], false); if(removeReq) req(F[k], false); });
      }
      function clearAllExcept(keepSet=new Set()){
        ALL_KEYS.forEach(k => { if (!keepSet.has(k)) clr(F[k]); });
      }
      function setEnabled(ids,on){ (ids||[]).forEach(id=>ena(F[id],on)); }
      function setRequired(ids,on){ (ids||[]).forEach(id=>req(F[id],on)); }
  
      function modoAlta(){
        disableAll(false);
        setEnabled(ALTA_REQ, true);
        setRequired(ALTA_REQ, true);
        req(F.numero_terminal_sef, false);
        show(grupoCampo,false);
        req(selCampo,false);
        if (origen) origen.value = esSust ? (creaUnidades ? "SUST_CREAR" : "NUEVA") : "NUEVA";
        applyRulesEngine();
      }
  
      function modoBaja(){
        const keep = new Set(['numero_terminal_sef']);

        // Limpia TODO excepto el terminal SEF
        clearAllExcept(keep);

        // Limpia selects y espejos para que no queden "SELECCIONA..." como texto
        clearSelectAndMirror(F.cpaeSelect,       MIR.cpae_nombre);
        clearSelectAndMirror(F.estadoSelect,     MIR.estado_nombre);
        clearSelectAndMirror(F.municipioSelect,  MIR.municipio_nombre);
        clearSelectAndMirror(F.empresa_traslado, MIR.etv_nombre);

        // Deshabilita todo y quita requireds
        disableAll(true);

        // Terminal SEF sí habilitado y requerido
        ena(F.numero_terminal_sef, true);
        req(F.numero_terminal_sef, true);

        // Oculta el selector de “campo a modificar”
        show(grupoCampo,false);
        req(selCampo,false);

        if (origen) origen.value = "SUST_BAJA";
        applyRulesEngine();

        // Re-evaluar terminales por si quedaron reglas previas
        document.getElementById('tipo_servicio_unidad')?.dispatchEvent(new Event('change', { bubbles:true }));
      }
  
      function modoModificacion(){
        disableAll(true);
        ena(F.numero_terminal_sef, true);
        req(F.numero_terminal_sef, true);
  
        show(grupoCampo,true);
        req(selCampo,true);
  
        const pick = (selCampo?.value || '').toUpperCase();
        const keep = new Set(['numero_terminal_sef']);
  
        switch(pick){
          case 'NOMBRE_UNIDAD':
            keep.add('nombre_unidad'); break;
          case 'CPAE':
            keep.add('cpaeSelect'); break;
          case 'SERVICIO_UNIDAD':
            keep.add('tipo_servicio_unidad'); break;
          case 'ETV':
            keep.add('empresa_traslado'); break;
          case 'DOMICILIO':
            PACK_DOM.forEach(k=>keep.add(k)); break;
          case 'TERM_INTEG':
            keep.add('terminal_integradora'); break;
          case 'TERM_DOT_CENT':
            keep.add('terminal_dotacion_centralizada'); break;
          case 'TERM_CERT_CENT':
            keep.add('terminal_certificado_centralizada'); break;
          default:
            clearAllExcept(keep);
            if (origen) origen.value = "SUST_MOD";
            applyRulesEngine();
            return;
        }
  
        clearAllExcept(keep);
        setEnabled([...keep], true);
        const reqSolo = [...keep].filter(k => k !== 'numero_terminal_sef');
        setRequired(reqSolo, true);
  
        if (origen) origen.value = "SUST_MOD";
        applyRulesEngine();
      }
  
      function aplicarReglaSinAccionUnidades(){
        const sinAccion = esSust && !modUnidades && !creaUnidades;
        if (!sinAccion) return false;
  
        // Deshabilita todo y quita required
        const form = document.querySelector('form.needs-validation') || document.querySelector('form');
        if (form) {
          form.querySelectorAll('input,select,textarea').forEach(el=>{
            if (el.type==='hidden' || el.type==='submit' || el.type==='button') return;
            el.disabled = true; el.removeAttribute('required');
          });
        }
        // Limpia selector de movimiento y oculta campo a modificar
        if (selMov) { selMov.innerHTML = '<option value="">(No aplica: no seleccionaste acción en Unidades)</option>'; selMov.value = ''; selMov.disabled = true; }
        show(grupoCampo,false); req(selCampo,false);
        // Oculta terminal y nombre para no confundir
        $('#grupo_terminal') && ( $('#grupo_terminal').style.display='none' );
        $('#grupo_nombre_unidad') && ( $('#grupo_nombre_unidad').style.display='none' );
        if (origen) origen.value = "SIN_ACCION_UNIDADES";
        applyRulesEngine();
        return true;
      }
  
      function configurarOpcionesTipoMovimiento(){
        if (!esSust || !selMov) return;
  
        if (aplicarReglaSinAccionUnidades()) return;
  
        if (modUnidades && !creaUnidades) {
          selMov.disabled = false;
          selMov.innerHTML =
            '<option value="">Selecciona…</option>' +
            '<option value="MODIFICACIÓN">MODIFICACIÓN UNIDAD DE NEGOCIO</option>' +
            '<option value="BAJA">BAJA UNIDAD DE NEGOCIO</option>';
        } else if (creaUnidades && !modUnidades) {
          selMov.innerHTML = '<option value="ALTA" selected>ALTA UNIDAD DE NEGOCIO</option>';
          selMov.disabled = true;
        } else {
          selMov.disabled = false;
          selMov.innerHTML =
            '<option value="">Selecciona…</option>' +
            '<option value="ALTA">ALTA UNIDAD DE NEGOCIO</option>' +
            '<option value="MODIFICACIÓN">MODIFICACIÓN UNIDAD DE NEGOCIO</option>' +
            '<option value="BAJA">BAJA UNIDAD DE NEGOCIO</option>';
        }
      }
  
      function aplicarUI(){
        if (!esSust || (!modUnidades && !creaUnidades)) {
          modoAlta();
          return;
        }
        const mov = (selMov?.value || '').toUpperCase();
        if (creaUnidades && !modUnidades) return modoAlta();
        if (modUnidades && !creaUnidades) {
          if (mov === 'BAJA') return modoBaja();
          if (mov === 'MODIFICACIÓN' || mov === 'MODIFICACION') return modoModificacion();
          show(grupoCampo, true); req(selCampo, true);
          disableAll(true); ena(F.numero_terminal_sef, true); req(F.numero_terminal_sef, true);
          applyRulesEngine();
          return;
        }
        if (mov === 'ALTA') return modoAlta();
        if (mov === 'BAJA') return modoBaja();
        return modoModificacion();
      }
  
      // Validación en submit
      const form = document.querySelector('form.needs-validation') || document.querySelector('form');
      form && form.addEventListener('submit', function(ev){
        aplicarUI();
        if (!form.checkValidity()) {
          ev.preventDefault();
          ev.stopPropagation();
          form.classList.add('was-validated');
        }
      });
  
      // Eventos
      selMov   && selMov.addEventListener('change', aplicarUI);
      selCampo && selCampo.addEventListener('change', aplicarUI);
  
      // Primera corrida
      configurarOpcionesTipoMovimiento();
      if (!aplicarReglaSinAccionUnidades()) aplicarUI();
    })();
  
    /* =========================
       6) Código Postal a 5 dígitos
       ========================= */
    (function cpCinco(){
      const cp = $('#codigo_postal');
      if (!cp) return;
      cp.addEventListener('input', function(){
        this.value = this.value.replace(/\D/g,'').slice(0,5);
      }, {passive:true});
      cp.addEventListener('blur', function(){
        const v = (this.value || '').replace(/\D/g,'');
        this.value = v.padStart(5, '0');
      });
    })();
  
    // Último: empuja reglas centralizadas si existen
    applyRulesEngine();
  });
</script>

{% endblock %}
