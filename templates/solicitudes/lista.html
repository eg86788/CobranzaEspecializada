{% extends "base.html" %}
{% block title %}{{ is_admin and 'Todas las solicitudes' or 'Mis solicitudes' }} — Servicios de Cobranza Especializada{% endblock %}
{% block steps %}{% endblock %}

{% block extra_head %}
<style>
  .lista-wrap { overflow-x: clip; }

  .table-compact {
    font-size: 0.75rem;  /* compacto y consistente */
    line-height: 1.2;
  }
  .table-compact th, .table-compact td{
    vertical-align: middle !important;
    white-space: nowrap;
    padding: .25rem .4rem;
  }
  .table-compact thead th{ font-weight: 600; }

  .col-rz { max-width: 400px; }
  .text-clip { overflow:hidden; text-overflow:ellipsis; display:inline-block; max-width:100%; }

  .col-acciones{ white-space:nowrap; width:1%; }

  .btn-icon{
    --bs-btn-padding-y:.2rem;
    --bs-btn-padding-x:.4rem;
    --bs-btn-font-size:.75rem;
  }
  .badge-tramite{ font-weight:600; letter-spacing:.2px; }

  @media (max-width: 768px){
    .col-fecha{ display:none; }
    .col-rz{ max-width:260px; }
    .table-compact{ font-size: 0.72rem; }
    /* en móviles, ocultamos la columna de Usuario para ahorrar espacio */
    .col-user{ display:none; }
  }
  @media (max-width: 576px){
    .col-rz{ max-width:200px; }
  }
</style>
{% endblock %}

{% block content %}
<div class="lista-wrap">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">
      {{ is_admin and 'Todas las solicitudes' or 'Mis solicitudes' }}
      {% if is_admin %}
        <span class="badge text-bg-dark ms-2" title="Vista de administrador">Admin</span>
      {% endif %}
    </h2>
    <div class="d-flex gap-2">
      <a href="/productos" class="btn btn-outline-secondary btn-sm">← Panel</a>
      <a href="{{ url_for('frames.nueva_solicitud') }}" class="btn btn-primary btn-sm">+ Nueva</a>
    </div>
  </div>

  <div class="table-responsive-xxl">
    <table class="table table-striped table-hover align-middle table-compact mb-0">
      <thead>
        <tr>
          <th style="width:1%;">#</th>
          <th style="width:10%;">Trámite</th>
          <th style="width:12%;">Contrato</th>
          <th style="width:12%;">Servicio</th>
          <th style="width:10%;">Cliente</th>
          <th class="col-rz" style="width:{{ is_admin and '28%' or '33%' }};">Razón social</th>
          {% if is_admin %}
            <th class="col-user" style="width:11%;">Usuario</th>
          {% endif %}
          <th class="col-fecha" style="width:12%;">Últ. Mod.</th>
          <th class="col-acciones text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for s in solicitudes %}
          {% set _id        = s.id or s['id'] %}
          {% set _tram_raw  = s.tipo_tramite if s.tipo_tramite is defined else s['tipo_tramite'] if 'tipo_tramite' in s else '' %}
          {% set _tram      = (_tram_raw or '') | upper %}
          {% set _contrato  = s.tipo_contrato if s.tipo_contrato is defined else s['tipo_contrato'] if 'tipo_contrato' in s else '' %}
          {% set _servicio  = s.tipo_servicio if s.tipo_servicio is defined else s['tipo_servicio'] if 'tipo_servicio' in s else '' %}
          {% set _num_cli   = s.numero_cliente if s.numero_cliente is defined else s['numero_cliente'] if 'numero_cliente' in s else '' %}
          {% set _rz        = s.razon_social if s.razon_social is defined else s['razon_social'] if 'razon_social' in s else '' %}
          {% set _updated   = s.updated_at if s.updated_at is defined else s['updated_at'] if 'updated_at' in s else None %}

          {# Valores de usuario/propietario (opcionales, sólo si el back los manda) #}
          {% set _owner =
              s.created_by_name if s.created_by_name is defined else
              s.username if s.username is defined else
              s.owner_name if s.owner_name is defined else
              s['created_by_name'] if 'created_by_name' in s else
              s['username'] if 'username' in s else
              s['owner_name'] if 'owner_name' in s else
              s['email'] if 'email' in s else
              s.created_by if s.created_by is defined else
              s['created_by'] if 'created_by' in s else
              None
          %}

          {% set ver_url    = url_for('frames.finalizar', solicitud_id=_id) %}
          {% set export_url = url_for('exportar.exportar_pdf', solicitud_id=_id, operativo_slug='anexo_operativo') %}

          <tr>
            <td class="text-muted">{{ _id }}</td>
            <td>
              {% set _t = (_tram or '').strip() %}
              {% if _t == 'ALTA' %}
                <span class="badge text-bg-primary badge-tramite">ALTA</span>
              {% elif _t in ('SUSTITUCIÓN','SUSTITUCION') %}
                <span class="badge text-bg-warning badge-tramite">Sustitución</span>
              {% else %}
                <span class="badge text-bg-secondary badge-tramite">{{ _t or '—' }}</span>
              {% endif %}
            </td>
            <td>{{ _contrato or '—' }}</td>
            <td>{{ _servicio or '—' }}</td>
            <td>{{ _num_cli or '—' }}</td>
            <td class="col-rz"><span class="text-clip w-100">{{ _rz or '—' }}</span></td>

            {% if is_admin %}
              <td class="col-user">
                {{ _owner or '—' }}
              </td>
            {% endif %}

            <td class="col-fecha">
              {% if _updated %}
                {% if _updated.strftime is defined %}
                  {{ _updated.strftime('%Y-%m-%d') }}
                {% else %}
                  {{ _updated }}
                {% endif %}
              {% else %}—{% endif %}
            </td>
            <td class="text-end">
              <div class="btn-group" role="group" aria-label="acciones">
                <a class="btn btn-outline-primary btn-icon"
                   href="{{ ver_url }}"
                   data-bs-toggle="tooltip" title="Ver / Continuar">
                  <i class="bi bi-eye"></i>
                  <span class="visually-hidden">Ver</span>
                </a>

                <a class="btn btn-success btn-icon btn-export-zip"
                   href="{{ export_url }}"
                   data-bs-toggle="tooltip" title="Exportar ZIP">
                  <i class="bi bi-file-zip"></i>
                  <span class="visually-hidden">Exportar ZIP</span>
                </a>
              </div>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="{{ is_admin and 9 or 8 }}" class="text-center text-muted py-4">
              No hay solicitudes registradas.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Tooltips
  const els = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  els.map(el => new bootstrap.Tooltip(el));

  // Feedback visual al exportar
  document.querySelectorAll('.btn-export-zip').forEach(btn => {
    btn.addEventListener('click', () => {
      const icon = btn.querySelector('i');
      if (icon) icon.className = 'bi bi-hourglass-split';
      btn.classList.add('disabled');
      btn.setAttribute('aria-disabled','true');
      btn.setAttribute('title','Generando…');
    });
  });
});
</script>
{% endblock %}
