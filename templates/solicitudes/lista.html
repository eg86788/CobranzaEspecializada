{% extends "base.html" %}
{% block title %}Mis solicitudes — Servicios de Cobranza Especializada{% endblock %}

{% block steps %}{% endblock %}

{% block extra_head %}
<style>
  .lista-wrap{ overflow-x: clip; }
  .table-compact{ font-size: 0.875rem; }
  .table-compact th, .table-compact td{
    vertical-align: middle !important;
    white-space: normal;
    word-break: break-word;
    hyphens: auto;
    padding-top: .4rem; padding-bottom: .4rem;
  }
  .table-compact thead th{ font-weight: 600; }
  .table-compact .col-acciones{ white-space: nowrap; width: 1%; }
  .badge-tramite{ font-weight: 600; letter-spacing: .2px; }
  .toolbar-actions .btn{ --bs-btn-padding-y:.35rem; --bs-btn-padding-x:.6rem; }
  .titulo-lista h2{ font-size: 1.25rem; margin: 0; }
  .titulo-lista small{ color: #6c757d; }
  @media (max-width: 576px){
    .table-compact{ font-size: 0.8125rem; }
    .toolbar-actions .btn{ --bs-btn-padding-y:.3rem; --bs-btn-padding-x:.5rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="lista-wrap">
  <div class="d-flex align-items-center justify-content-between mb-3 titulo-lista">
    <div>
      <h2 class="mb-0">Mis solicitudes</h2>
      <small>Consulta, edita o exporta tus solicitudes.</small>
    </div>
    <div class="d-flex gap-2 toolbar-actions">
      <a class="btn btn-primary" href="{{ url_for('frames.frame1') }}">
        <i class="bi bi-plus-circle me-1"></i>Nueva solicitud
      </a>
    </div>
  </div>

  <div class="table-responsive-xxl">
    <table class="table table-striped table-hover align-middle table-compact mb-0">
      <thead>
        <tr>
          <th style="width:1%;">ID</th>
          <th style="width:10%;">Fecha</th>
          <th style="width:10%;">No. Cliente</th>
          <th style="width:12%;">No. Contrato</th>
          <th style="width:32%;">Razón Social</th>
          <th style="width:12%;">Tipo Trámite</th>
          <th class="col-acciones text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for s in solicitudes %}
          {% set _id = s.id or s['id'] %}
          {% set _fecha = s.updated_at if s.updated_at is defined else s['updated_at'] if 'updated_at' in s else None %}
          {% set _num_cli = s.numero_cliente if s.numero_cliente is defined else s['numero_cliente'] if 'numero_cliente' in s else '' %}
          {% set _num_cto = s.numero_contrato if s.numero_contrato is defined else s['numero_contrato'] if 'numero_contrato' in s else '' %}
          {% set _rz = s.razon_social if s.razon_social is defined else s['razon_social'] if 'razon_social' in s else '' %}
          {% set _tram = (s.tipo_tramite if s.tipo_tramite is defined else s['tipo_tramite'] if 'tipo_tramite' in s else '') | upper %}
          {% set _firmantes_ok = (s.firmantes_completos if s.firmantes_completos is defined else True) %}

          {% set ver_url = url_for('frames.finalizar', solicitud_id=_id) %}
          {# Corrección: usar exportar.exportar_pdf en lugar de exportar.exportar_zip #}
          {% set export_url = url_for('exportar.exportar_pdf', solicitud_id=_id) %}

          <tr>
            <td class="text-muted">{{ _id }}</td>
            <td>
              {% if _fecha %}
                {% if _fecha.strftime is defined %}
                  {{ _fecha.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                  {{ _fecha }}
                {% endif %}
              {% else %}—{% endif %}
            </td>
            <td>{{ _num_cli or '—' }}</td>
            <td>{{ _num_cto or '—' }}</td>
            <td>{{ _rz or '—' }}</td>
            <td>
              {% set _t = _tram.strip() %}
              {% if _t == 'ALTA' %}
                <span class="badge text-bg-primary badge-tramite">ALTA</span>
              {% elif _t == 'SUSTITUCIÓN' or _t == 'SUSTITUCION' %}
                <span class="badge text-bg-warning badge-tramite">Sustitución</span>
              {% else %}
                <span class="badge text-bg-secondary badge-tramite">{{ _t or '—' }}</span>
              {% endif %}
            </td>
            <td class="text-end">
              <div class="btn-group btn-group-sm" role="group" aria-label="acciones">
                <a class="btn btn-outline-primary" href="{{ ver_url }}">
                  <i class="bi bi-eye me-1"></i>Ver
                </a>
                {% if _firmantes_ok %}
                  <a class="btn btn-outline-success" href="{{ export_url }}">
                    <i class="bi bi-file-earmark-pdf me-1"></i>Exportar
                  </a>
                {% else %}
                  <button class="btn btn-outline-success" type="button" disabled title="Completa firmantes para habilitar la exportación">
                    <i class="bi bi-file-earmark-pdf me-1"></i>Exportar
                  </button>
                {% endif %}
              </div>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">No hay solicitudes registradas.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
