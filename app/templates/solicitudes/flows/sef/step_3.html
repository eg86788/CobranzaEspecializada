{% extends "base.html" %}
{% block content %}

<div class="container mt-4">

  <h4 class="mb-3">
    {% include "components/_progress_steps.html" %}
    Servicios de Efectivo
    <small class="text-muted">– Unidades de Negocio</small>
  </h4>

  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-light">
      <strong>{{ 'Editar Unidad' if unidad_editar else 'Agregar nueva Unidad' }}</strong>
    </div>

    <div class="card-body">

      <form method="POST" class="needs-validation" novalidate>

        <!-- ========================= -->
        <!-- DATOS GENERALES -->
        <!-- ========================= -->
        <div class="row g-3">

          <div class="col-md-4">
            <label class="form-label">Acción</label>
            <select name="accion_unidad" class="form-select" required>
              <option value="">Selecciona...</option>
              <option value="ALTA"
                {% if unidad_editar and unidad_editar.accion_unidad == "ALTA" %}selected{% endif %}>
                ALTA
              </option>
              <option value="MODIFICACION"
                {% if unidad_editar and unidad_editar.accion_unidad == "MODIFICACION" %}selected{% endif %}>
                MODIFICACIÓN
              </option>
              <option value="BAJA"
                {% if unidad_editar and unidad_editar.accion_unidad == "BAJA" %}selected{% endif %}>
                BAJA
              </option>
            </select>
            <div class="invalid-feedback">Debe seleccionar una acción.</div>
          </div>

          <div class="col-md-8">
            <label class="form-label">Nombre Unidad</label>
            <input type="text"
                   name="nombre_unidad"
                   class="form-control"
                   required
                   value="{{ unidad_editar.nombre_unidad if unidad_editar else '' }}">
            <div class="invalid-feedback">Campo obligatorio.</div>
          </div>

        </div>

        <hr class="my-4">

        <!-- ========================= -->
        <!-- AUTOCOMPLETE -->
        <!-- ========================= -->
        <div class="row g-3">

          <div class="col-md-4">
            <label>CPAE</label>
            <input type="text"
                   id="cpae_search"
                   class="form-control"
                   value="{{ unidad_editar.cpae.descripcion if unidad_editar and unidad_editar.cpae else '' }}">
            <input type="hidden"
                   name="cpae_id"
                   id="cpae_id"
                   value="{{ unidad_editar.cpae_id if unidad_editar and unidad_editar.cpae_id else '' }}">
                  <ul id="cpae_results" class="list-group"></ul>
          </div>

          <div class="col-md-4">
            <label>ETV</label>
            <input type="text"
                   id="etv_search"
                   class="form-control"
                   value="{{ unidad_editar.etv.nombre if unidad_editar and unidad_editar.etv else '' }}">
            <input type="hidden"
                   name="etv_id"
                   id="etv_id"
                   value="{{ unidad_editar.etv_id if unidad_editar and unidad_editar.etv_id else '' }}">
                        <ul id="etv_results" class="list-group"></ul>
          </div>

          <div class="col-md-4">
            <label>Procesadora</label>
            <input type="text"
                   id="procesadora_search"
                   class="form-control"
                   value="{{ unidad_editar.procesadora.nombre if unidad_editar and unidad_editar.procesadora else '' }}">
            <input type="hidden"
                   name="procesadora_id"
                   id="procesadora_id"
                   value="{{ unidad_editar.procesadora_id if unidad_editar and unidad_editar.procesadora_id else '' }}">
            <ul id="procesadora_results" class="list-group"></ul>
          </div>

        </div>

        <hr class="my-4">

        <!-- ========================= -->
        <!-- SERVICIOS -->
        <!-- ========================= -->
        <h6>Servicios</h6>

        <div class="row g-3">

          <div class="col-md-4 form-check">
            <input class="form-check-input"
                   type="checkbox"
                   name="servicio_verificacion_tradicional"
                   {% if unidad_editar and unidad_editar.servicio_verificacion_tradicional %}checked{% endif %}>
            <label class="form-check-label">Depósito Tradicional</label>
          </div>

          <div class="col-md-4 form-check">
            <input class="form-check-input"
                   type="checkbox"
                   name="servicio_verificacion_electronica"
                   {% if unidad_editar and unidad_editar.servicio_verificacion_electronica %}checked{% endif %}>
            <label class="form-check-label">Depósito Electrónico</label>
          </div>

          <div class="col-md-4 form-check">
            <input class="form-check-input"
                   type="checkbox"
                   name="servicio_dotacion"
                   {% if unidad_editar and unidad_editar.servicio_dotacion %}checked{% endif %}>
            <label class="form-check-label">Dotación Electrónica</label>
          </div>

          <div class="col-md-4 form-check">
            <input class="form-check-input"
                   type="checkbox"
                   name="servicio_traslado"
                   {% if unidad_editar and unidad_editar.servicio_traslado %}checked{% endif %}>
            <label class="form-check-label">Traslado de Valores</label>
          </div>

          <div class="col-md-4 form-check">
            <input class="form-check-input"
                   type="checkbox"
                   name="servicio_cofre"
                   {% if unidad_editar and unidad_editar.servicio_cofre %}checked{% endif %}>
            <label class="form-check-label">Renta de Cofre</label>
          </div>

        </div>

        <hr class="my-4">

        <!-- ========================= -->
        <!-- DOMICILIO -->
        <!-- ========================= -->
        <div class="row g-3">

          <div class="col-md-6">
            <label class="form-label">Calle y Número</label>
            <input type="text"
                   name="calle_numero"
                   class="form-control"
                   value="{{ unidad_editar.calle_numero if unidad_editar else '' }}">
          </div>

          <div class="col-md-3">
            <label>Entidad Federativa</label>
            <select name="entidad_id"
                    id="entidad_select"
                    class="form-select">
              <option value="">Seleccione</option>
              {% for e in entidades %}
                <option value="{{ e.id }}"
                  {% if unidad_editar and unidad_editar.entidad_id == e.id %}selected{% endif %}>
                  {{ e.nombre }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3">
            <label>Municipio</label>
            <select name="municipio_id"
                    id="municipio_select"
                    class="form-select">
              <option value="">Seleccione</option>
            </select>
          </div>

          <div class="col-md-3">
            <label>Código Postal</label>
            <input type="text"
                   name="codigo_postal"
                   class="form-control"
                   data-type="codigo_postal"
                   value="{{ unidad_editar.codigo_postal if unidad_editar else '' }}">
          </div>

        </div>

        <div class="mt-4">
          <button type="submit" class="btn btn-primary btn-sm">
            Guardar Unidad
          </button>
        </div>

        <input type="hidden" name="unidad_id"
               value="{{ unidad_editar.id if unidad_editar else '' }}">
        <input type="hidden" name="guardar_unidad" value="1">

      </form>

    </div>
  </div>

    <!-- ===================== LISTADO ===================== -->

    <div class="card">
      <div class="card-header bg-light">
        <strong>Unidades capturadas</strong>
      </div>
      <div class="card-body p-0">
  
        {% if sef and unidades %}
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead class="table-light">
              <tr>
                <th>Acción</th>
                <th>Nombre</th>
                <th>CPAE</th>
                <th>ETV</th>
                <th>Servicios</th>
                <th width="120">Opciones</th>
              </tr>
            </thead>
            <tbody>
              {% for u in unidades %}
              <tr>
                <td>{{ u.accion_unidad }}</td>
                <td>{{ u.nombre_unidad }}</td>
                <td>{{ u.cpae.descripcion if u.cpae else '' }}</td>
                <td>{{ u.etv.nombre if u.etv else '' }}</td>
                <td>
                  {% if u.servicio_verificacion_tradicional %}VT {% endif %}
                  {% if u.servicio_verificacion_electronica %}VE {% endif %}
                  {% if u.servicio_dotacion %}DOT {% endif %}
                  {% if u.servicio_traslado %}TRAS {% endif %}
                  {% if u.servicio_cofre %}COFRE {% endif %}
                </td>
                <td>
                  <a href="?editar={{ u.id }}"
                     class="btn btn-sm btn-primary">
                    Editar
                  </a>
  
                  <form method="POST"
                        style="display:inline;"
                        onsubmit="return confirm('¿Eliminar esta unidad?');">
                    <input type="hidden"
                           name="eliminar_unidad_id"
                           value="{{ u.id }}">
                    <button type="submit"
                            class="btn btn-sm btn-danger">
                      X
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="p-3 text-muted">
            No hay unidades registradas.
          </div>
        {% endif %}
  
      </div>
    </div>

      <!-- ================= NAV ================= -->

      <div class="mt-4 d-flex justify-content-between">
        <a href="{{ url_for('solicitudes_flow.step', solicitud_id=sef.solicitud_id, step=2) }}"
        class="btn btn-outline-secondary btn-sm">
        ← Regresar
        </a>

       <a href="{{ url_for('solicitudes_flow.step', solicitud_id=sef.solicitud_id, step=4) }}"
        class="btn btn-primary px-4">
        Continuar →
       </a>
     </div>

</div>

<script>
(() => {
  'use strict'
  const forms = document.querySelectorAll('.needs-validation')
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault()
        event.stopPropagation()
      }
      form.classList.add('was-validated')
    }, false)
  })
})();
</script>

<script>
// Cargar municipios si ya hay entidad seleccionada
document.addEventListener("DOMContentLoaded", function () {

  const entidadSelect = document.getElementById("entidad_select");
  const municipioSelect = document.getElementById("municipio_select");

  function cargarMunicipios(entidadId, seleccionado=null) {
    if (!entidadId) return;

    fetch(`/catalogos/municipios/${entidadId}`)
      .then(res => res.json())
      .then(data => {
        municipioSelect.innerHTML = "<option value=''>Seleccione</option>";

        data.results.forEach(item => {
          const option = document.createElement("option");
          option.value = item.id;
          option.textContent = item.text;

          if (seleccionado && seleccionado == item.id) {
            option.selected = true;
          }

          municipioSelect.appendChild(option);
        });
      });
  }

  entidadSelect.addEventListener("change", function () {
    cargarMunicipios(this.value);
  });

  {% if unidad_editar and unidad_editar.entidad_id %}
    cargarMunicipios(
      "{{ unidad_editar.entidad_id }}",
      "{{ unidad_editar.municipio_id }}"
    );
  {% endif %}

});
</script>

{% endblock %}
